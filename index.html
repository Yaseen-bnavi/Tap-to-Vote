<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Supreme Strategic Campaign Simulator (Iraq)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 70%, #0f172a 100%);
            overscroll-behavior-y: contain;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .tap-feedback {
            position: absolute;
            font-size: 2.2rem;
            font-weight: 900;
            color: #fcd34d;
            text-shadow: 0 2px 8px #000;
            pointer-events: none;
            animation: floatup 0.9s ease-out forwards;
            white-space: nowrap;
            z-index: 100;
        }
        @keyframes floatup {
            0% { transform: translateY(0) scale(1.2); opacity: 1; }
            100% { transform: translateY(-80px) scale(0.8); opacity: 0; }
        }
        #tapButton {
            width: 230px;
            height: 230px;
            background: radial-gradient(circle at center, #3b82f6 0%, #1e40af 70%, #1e3a8a 100%);
            border: 6px solid #fef3c7;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.9);
            box-shadow: 0 15px 40px rgba(37, 99, 235, 0.7), 0 0 0 15px rgba(254, 243, 199, 0.2);
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            touch-action: manipulation;
        }
        #tapButton.boost-active {
             animation: boostPulse 1s infinite;
        }
        @keyframes boostPulse {
            0% { box-shadow: 0 15px 40px rgba(37, 99, 235, 0.7), 0 0 0 15px rgba(254, 243, 199, 0.2); }
            50% { box-shadow: 0 20px 60px rgba(59, 130, 246, 0.9), 0 0 0 20px rgba(254, 243, 199, 0.5); }
            100% { box-shadow: 0 15px 40px rgba(37, 99, 235, 0.7), 0 0 0 15px rgba(254, 243, 199, 0.2); }
        }
        #tapButton:active { transform: scale(0.95); }
        .nav-item.active { color: #3b82f6; background-color: #1e293b; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1001; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 1000; }
        /* ‚úÖ ADDED for locked cards */
        .filter-grayscale { filter: grayscale(1); }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="text-slate-100 p-4 pb-24 max-w-lg mx-auto min-h-screen">

    <div id="loadingIndicator" class="fixed inset-0 bg-gray-900/90 z-[2000] flex justify-center items-center">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-yellow-500 mb-4"></div>
            <p class="text-white text-xl">Loading Campaign Data...</p>
        </div>
    </div>

    <div id="messageBox" class="fixed bottom-24 left-1/2 -translate-x-1/2 w-[90%] max-w-md z-[100]"></div>
    
    <!-- ‚úÖ MODIFIED: Admin button is now hidden by default to prevent non-admins from seeing it -->
    <button id="adminToggle" style="display: none;" class="fixed top-4 right-4 z-50 bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg"><i class="fa fa-cog"></i></button>

    <header id="header" class="w-full mb-4 p-4 bg-slate-800/80 rounded-xl shadow-2xl border border-slate-700/50 sticky top-4 z-30">
        <!-- Header content will be dynamically rendered by JS -->
    </header>

    <main class="w-full flex-grow">
        <div id="tap" class="tab-content flex flex-col items-center"></div>
        <div id="cards" class="tab-content hidden"></div>
        <div id="missions" class="tab-content hidden"></div>
        <div id="media" class="tab-content hidden"></div>
        <div id="party" class="tab-content hidden"></div>
        <div id="store" class="tab-content hidden"></div>
        <div id="leaderboard" class="tab-content hidden"></div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto w-full flex justify-around p-2 border-t border-gray-700/50 rounded-t-xl z-40 bg-[#0f172a]">
        <!-- Nav items will be dynamically rendered by JS -->
    </nav>
    
    <div id="modalContainer"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

// ==========================================
// üîí ADMIN & ASSET CONFIGURATION
// ==========================================
const YOUR_ADMIN_TELEGRAM_ID = "Mohammaed_Abdulhmaeed"; // <-- ‚ö†Ô∏è REPLACE WITH YOUR TELEGRAM ID

// ‚úÖ Base URL for your GitHub images. Assumes /photos/ and /logos/ folders exist.
const GITHUB_ASSETS_BASE_URL = 'https://raw.githubusercontent.com/Yaseen-bnavi/Tap-to-Vote/main/';
// ==========================================


// --- CONSTANTS & CONFIG (Original values maintained) ---
const TCI_SCALING = { COINS: 10000, CARD_LEVEL: 10, PARTY_LEVEL: 50 };
const ENERGY_MAX = 100;
const ENERGY_REGEN_RATE = 1;
const COMBO_TIMEOUT = 2000;
const STREAK_BONUS = [0, 5, 10, 15, 20, 25, 30, 40, 50, 75];
const DAILY_GOAL = 100;
const DAILY_REWARD_COINS = 5000;
const DAILY_REWARD_TOKENS = 1;

// ‚úÖ Using the main branch for config files for easier updates
const CONFIG_URLS = {
    parties: `${GITHUB_ASSETS_BASE_URL}config/parties.json`,
    candidates: `${GITHUB_ASSETS_BASE_URL}config/candidates.json`,
    managers: `${GITHUB_ASSETS_BASE_URL}config/managers.json`
};

const ADMIN_CONTACT = {
    telegram: '@campaign_admin',
    email: 'admin@campaign.com',
    phone: '+964 XXX XXX XXXX',
    instructions: 'Contact us to activate your candidate or party card. Payment required for activation services.',
    pricing: {
        candidate: '50,000 IQD per month',
        party: '100,000 IQD per month',
        sponsorship: '200,000 IQD per month'
    }
};

const ACHIEVEMENTS = [
    { id: 'taps1', type: 'taps', threshold: 100, title: "First Steps", description: "Reach 100 total taps" },
    { id: 'taps2', type: 'taps', threshold: 500, title: "Getting Serious", description: "Reach 500 total taps" },
    { id: 'taps3', type: 'taps', threshold: 1000, title: "Dedicated Campaigner", description: "Reach 1,000 total taps" },
    { id: 'coins1', type: 'coins', threshold: 10000, title: "Wealthy Backer", description: "Accumulate 10,000 coins" },
    { id: 'cards1', type: 'cards', threshold: 3, title: "Building a Team", description: "Own 3 candidate cards" },
];

const DAILY_MISSIONS = [
    { id: 1, type: 'taps', target: 50, reward: 1000, title: "Tap 50 Times", description: "Basic tapping mission" },
    { id: 2, type: 'taps', target: 200, reward: 5000, title: "Tap 200 Times", description: "Advanced tapping mission" },
    { id: 3, type: 'coins', target: 10000, reward: 2000, title: "Earn 10,000 Funds", description: "Wealth accumulation" },
    { id: 4, type: 'level', target: 3, reward: 3000, title: "Upgrade a Card to Lv.3", description: "Strengthen your team" },
];

const BOOSTS = [
    { id: 'boost_2x', name: "2x Multiplier", duration: 60, cost: 5000, multiplier: 2, icon: '‚ö°' },
    { id: 'boost_energy', name: "Energy Refill", duration: 0, cost: 3000, energy: 50, icon: 'üîã' },
];

let GAME_CONFIG = { parties: {}, candidates: [], managers: [] };
let gameState;
let activeTab = 'tap';
let messageTimeout;
let telegramUser = null;

const formatNumber = (num) => {
  if (isNaN(num) || num === null) return '0';
  if (num >= 1_000_000) return `${(num / 1_000_000).toFixed(1)}M`;
  if (num >= 1_000) return `${(num / 1_000).toFixed(1)}K`;
  return Math.floor(num).toString();
};

const getTodayString = () => new Date().toISOString().split('T')[0];

const showMessage = (text, type = 'info') => {
    const messageBox = document.getElementById('messageBox');
    if (!messageBox) return;
    clearTimeout(messageTimeout);
    const color = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
    messageBox.innerHTML = `<div class="${color} text-white text-center font-bold p-3 rounded-lg shadow-lg animate-pulse">${text}</div>`;
    messageTimeout = setTimeout(() => { messageBox.innerHTML = ''; }, 3000);
};

const loadExternalConfig = async () => {
    try {
        let persistedConfig = JSON.parse(localStorage.getItem('campaignConfig') || 'null');

        const fetchAndMerge = async (url, key, type) => {
            const response = await fetch(`${url}?v=${Date.now()}`);
            if (!response.ok) throw new Error(`Failed to load ${key}`);
            const freshData = await response.json();
            GAME_CONFIG[key] = persistedConfig ? mergeConfigs(freshData, persistedConfig[key] || {}, type) : freshData;
        };

        await Promise.all([
            fetchAndMerge(CONFIG_URLS.parties, 'parties', 'parties'),
            fetchAndMerge(CONFIG_URLS.candidates, 'candidates', 'candidates'),
            fetchAndMerge(CONFIG_URLS.managers, 'managers', 'managers')
        ]);
        console.log('üéâ All external config loaded successfully!');
    } catch (error) {
        console.error('‚ùå Error loading external config:', error);
        // Fallback to default config if loading fails
        GAME_CONFIG = {
            parties: {
                p1: { name: "Sairoon Current", logo: 'party1.png', color: 'bg-red-700/80', description: "A cross-sectarian alliance.", photo: "party1.png", active: true, promoVideo: "https://www.youtube.com/embed/P_wKDMcr16g", videoReward: 3000 },
                p2: { name: "Fatah Alliance", logo: 'party2.png', color: 'bg-green-700/80', description: "Coalition of Iran-backed parties.", photo: "party2.png", active: false, promoVideo: "https://www.youtube.com/embed/P_wKDMcr16g", videoReward: 3000 },
            },
            candidates: [
                { id: 1, name: "Default Candidate", party: "p1", campaign: "Default Campaign", baseBonus: 1, bid: 1000, maxLevel: 5, logoColor: "border-blue-500", policy: "Default policy.", approval: 50, logo: '‚≠ê', photo: "candidate1.jpg", promoVideo: "https://www.youtube.com/embed/dQw4w9WgXcQ", videoReward: 1000, bio: "Default candidate bio.", profitPerHour: 10, active: true, sponsored: false },
            ],
            managers: [
                { id: 'm1', name: "Default Manager", icon: 'üì±', description: "Default manager description", effect: 1.2, cost: 5000 }
            ]
        };
        showMessage('Using default configuration', 'info');
    }
};

const mergeConfigs = (freshConfig, persistedConfig, configType) => {
    if (configType === 'candidates') {
        return freshConfig.map(freshCandidate => {
            const persistedCandidate = Array.isArray(persistedConfig) ? persistedConfig.find(p => p.id === freshCandidate.id) : null;
            return { 
                ...freshCandidate, 
                active: persistedCandidate?.active ?? freshCandidate.active,
                sponsored: persistedCandidate?.sponsored ?? freshCandidate.sponsored
            };
        });
    } else if (configType === 'parties') {
        const merged = { ...freshConfig };
        Object.keys(persistedConfig).forEach(key => {
            if (merged[key]) {
                merged[key] = { 
                    ...merged[key], 
                    active: persistedConfig[key]?.active ?? merged[key].active
                };
            }
        });
        return merged;
    }
    return freshConfig;
};

const saveConfigChanges = () => {
    try {
        const configToSave = {
            parties: GAME_CONFIG.parties,
            candidates: GAME_CONFIG.candidates,
            managers: GAME_CONFIG.managers,
            lastUpdated: Date.now()
        };
        localStorage.setItem('campaignConfig', JSON.stringify(configToSave));
        console.log('‚úÖ Config changes saved to localStorage');
    } catch (e) {
        console.error('‚ùå Could not save config changes to localStorage', e);
    }
};

const calculatePPH = (state) => {
    let totalPPH = 0;
    if (!state || !state.userCards) return 0;
    state.userCards.forEach(card => {
        if (card.activated) {
            const candidate = GAME_CONFIG.candidates.find(c => c.id === card.id);
            if (candidate) {
                let profit = candidate.profitPerHour * card.level;
                state.managerCards.forEach(managerId => {
                    const manager = GAME_CONFIG.managers.find(m => m.id === managerId);
                    if (manager) profit *= manager.effect;
                });
                totalPPH += profit;
            }
        }
    });
    return Math.floor(totalPPH);
};

const calculateTCI = (state) => {
    if (!state) return 0;
    const coinsTCI = (state.totalLifetimeCoins || 0) / TCI_SCALING.COINS;
    const cardsTCI = (state.userCards?.reduce((acc, card) => acc + (card.level || 1), 0) || 0) * TCI_SCALING.CARD_LEVEL;
    const partiesTCI = (Object.values(state.parties)?.reduce((acc, party) => acc + (party.level || 1), 0) || 0) * TCI_SCALING.PARTY_LEVEL;
    return Math.floor(coinsTCI + cardsTCI + partiesTCI);
};

const calculateTapPower = (state) => {
    if (!state) return 1;
    let basePower = 1 + (state.userCards?.reduce((acc, card) => {
        if(card.activated) {
            const c = GAME_CONFIG.candidates.find(c => c.id === card.id);
            return acc + (c ? c.baseBonus * (card.level || 1) : 0);
        }
        return acc;
    }, 0) || 0);
    
    let partyMultiplier = 1 + (Object.values(state.parties)?.reduce((acc, p) => acc + (p.level > 1 ? ((GAME_CONFIG.parties[p.id]?.multiplier || 1.05) - 1) * p.level : 0), 0) || 0);
    const boostMultiplier = state.activeBoosts?.reduce((acc, b) => acc * (b.multiplier || 1), 1) || 1;
    const streakBonus = 1 + (STREAK_BONUS[state.streak || 0] / 100);

    return Math.floor(basePower * partyMultiplier * boostMultiplier * streakBonus);
};

const saveGameState = () => {
    if(!gameState) return;
    try {
        gameState.lastPlayTime = Date.now();
        localStorage.setItem('campaignSimulatorSave', JSON.stringify(gameState));
        saveToLeaderboard();
    } catch (e) {
        console.warn("Could not save game state to localStorage.", e);
    }
};

const saveToLeaderboard = () => {
    try {
        const leaderboardData = JSON.parse(localStorage.getItem('campaignLeaderboard') || '{}');
        const userKey = telegramUser ? `tg_${telegramUser.id}` : gameState.userId;
        
        leaderboardData[userKey] = {
            username: telegramUser?.username || gameState.telegramUsername || 'Anonymous',
            telegramId: telegramUser?.id || 'unknown',
            firstName: telegramUser?.first_name || '',
            lastName: telegramUser?.last_name || '',
            score: gameState.totalCampaignInfluence,
            coins: gameState.coins,
            totalTaps: gameState.totalTaps,
            totalLifetimeCoins: gameState.totalLifetimeCoins,
            achievements: gameState.achievements.length,
            cardsOwned: gameState.userCards.length,
            lastUpdated: new Date().toISOString()
        };
        
        localStorage.setItem('campaignLeaderboard', JSON.stringify(leaderboardData));
    } catch (e) {
        console.warn("Could not save to leaderboard.", e);
    }
};

const createDefaultGameState = () => ({
    coins: 1000, influenceTokens: 0, dailyTaps: 0, totalTaps: 0,
    totalLifetimeCoins: 1000, userCards: [],
    parties: Object.keys(GAME_CONFIG.parties).reduce((acc, partyId) => {
        acc[partyId] = { level: 1, xp: 0, multiplier: 1.05, totalInvestment: 0 };
        return acc;
    }, {}),
    lastDailyRewardDate: null, 
    userId: 'user_' + Math.random().toString(36).substr(2, 9),
    watchedVideos: {}, managerCards: [], lastPlayTime: Date.now(),
    achievements: [], energy: ENERGY_MAX, lastEnergyUpdate: Date.now(),
    combo: 0, lastTapTime: 0, streak: 0,
    lastLoginDate: null, activeBoosts: [], completedMissions: [],
    missionProgress: DAILY_MISSIONS.reduce((acc, m) => { acc[m.id] = { progress: 0 }; return acc; }, {}),
    telegramUsername: 'user_' + Math.random().toString(36).substr(2, 6),
    telegramId: null,
    telegramFirstName: null,
    telegramLastName: null,
    appVersion: '1.5.0'
});

const loadGameState = () => {
    let savedStateJSON = null;
    try {
        savedStateJSON = localStorage.getItem('campaignSimulatorSave');
    } catch (e) {
        console.warn("Could not access localStorage.", e);
    }

    const defaultState = createDefaultGameState();
    let initialState = defaultState;
    if (savedStateJSON) {
        try {
            const parsed = JSON.parse(savedStateJSON);
            // Properly merge the state to preserve all properties
            initialState = { 
                ...defaultState, 
                ...parsed,
                parties: { ...defaultState.parties, ...parsed.parties },
                missionProgress: { ...defaultState.missionProgress, ...parsed.missionProgress }
            };
        } catch (e) {
            console.error("Failed to parse saved state, starting fresh.", e);
            initialState = defaultState;
        }
    }
    
    const now = Date.now();
    const timeOfflineHours = (now - initialState.lastPlayTime) / (1000 * 3600);
    const pph = calculatePPH(initialState);
    const offlineEarnings = Math.min(Math.floor(pph * timeOfflineHours), pph * 24);
    if (offlineEarnings > 0) {
        initialState.coins += offlineEarnings;
        initialState.totalLifetimeCoins += offlineEarnings;
        setTimeout(() => showMessage(`Welcome back! You earned ${formatNumber(offlineEarnings)} üí∞ while offline.`, 'success'), 1000);
    }
    
    const today = getTodayString();
    if (initialState.lastLoginDate !== today) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        initialState.streak = initialState.lastLoginDate === yesterday.toISOString().split('T')[0]
            ? Math.min(initialState.streak + 1, STREAK_BONUS.length - 1)
            : 1;
        initialState.lastLoginDate = today;
        initialState.dailyTaps = 0;
        initialState.completedMissions = [];
        initialState.missionProgress = DAILY_MISSIONS.reduce((acc, m) => { acc[m.id] = { progress: 0 }; return acc; }, {});
    }

    gameState = initialState;
};

const updateAll = () => {
    if (!gameState) return;
    gameState.tapPower = calculateTapPower(gameState);
    gameState.totalCampaignInfluence = calculateTCI(gameState);
    renderHeader();
    renderCurrentTab();
    saveGameState();
};

const checkAchievements = () => {
    const unlocked = [];
    ACHIEVEMENTS.forEach(ach => {
        if (gameState.achievements.includes(ach.id)) return;
        let conditionMet = false;
        if (ach.type === 'taps' && gameState.totalTaps >= ach.threshold) conditionMet = true;
        if (ach.type === 'coins' && gameState.totalLifetimeCoins >= ach.threshold) conditionMet = true;
        if (ach.type === 'cards' && gameState.userCards.length >= ach.threshold) conditionMet = true;
        if (conditionMet) {
            gameState.achievements.push(ach.id);
            unlocked.push(ach);
        }
    });
    if (unlocked.length > 0) {
        const achievement = unlocked[0];
        const content = `<div class="text-center"><div class="text-6xl mb-2">üèÜ</div><p class="text-gray-300">${achievement.description}</p></div>`;
        renderModal(`Achievement: ${achievement.title}`, content);
        saveGameState();
    }
};

const handleTap = (e) => {
    e.preventDefault();
    if (gameState.energy < 1) {
        showMessage("Not enough energy! Wait for regeneration.", "error");
        return;
    }

    const now = Date.now();
    gameState.energy -= 1;
    let tapValue = calculateTapPower(gameState);
    
    // Critical hit chance
    const isCritical = Math.random() < 0.05; // 5% chance
    if (isCritical) tapValue *= 3;
    
    gameState.combo = (now - gameState.lastTapTime < COMBO_TIMEOUT) ? gameState.combo + 1 : 1;
    let comboMultiplier = 1 + Math.min(gameState.combo * 0.05, 1);
    tapValue = Math.floor(tapValue * comboMultiplier);

    const { clientX, clientY } = e.touches ? e.touches[0] : e;
    const feedback = document.createElement('div');
    feedback.className = 'tap-feedback' + (isCritical ? ' text-amber-300 scale-125' : '');
    feedback.textContent = `+${formatNumber(tapValue)}` + (isCritical ? ' CRITICAL!' : '');
    feedback.style.left = `${clientX - 25}px`;
    feedback.style.top = `${clientY - 45}px`;
    document.body.appendChild(feedback);
    setTimeout(() => { feedback.remove(); }, 900);

    gameState.coins += tapValue;
    gameState.totalTaps += 1;
    gameState.dailyTaps += 1;
    gameState.totalLifetimeCoins += tapValue;
    gameState.lastTapTime = now;
    
    checkMissionProgress('taps', 1);
    checkMissionProgress('coins', tapValue);
    
    if(gameState.dailyTaps === DAILY_GOAL && getTodayString() !== gameState.lastDailyRewardDate) {
        gameState.coins += DAILY_REWARD_COINS;
        gameState.influenceTokens += DAILY_REWARD_TOKENS;
        gameState.lastDailyRewardDate = getTodayString();
        showMessage(`Daily Goal! +${formatNumber(DAILY_REWARD_COINS)}üí∞ & +${DAILY_REWARD_TOKENS}üíé`, 'success');
    }
    
    checkAchievements();
    updateAll();
};

const checkMissionProgress = (type, value) => {
    let missionCompleted = false;
    DAILY_MISSIONS.forEach(mission => {
        if(mission.type === type && !gameState.completedMissions.includes(mission.id)) {
            const progress = gameState.missionProgress[mission.id];
            if (!progress) {
                gameState.missionProgress[mission.id] = { progress: 0 };
            }
            progress.progress += value;
            if (progress.progress >= mission.target) {
                gameState.completedMissions.push(mission.id);
                gameState.coins += mission.reward;
                gameState.totalLifetimeCoins += mission.reward;
                showMessage(`Mission Complete: ${mission.title}! +${formatNumber(mission.reward)}üí∞`, 'success');
                missionCompleted = true;
            }
        }
    });
    if(missionCompleted) updateAll();
};

const navigate = (tabName) => {
    activeTab = tabName;
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.getElementById(tabName)?.classList.remove('hidden');
    renderNav();
    renderCurrentTab();
};

const renderCurrentTab = () => {
    const container = document.getElementById(activeTab);
    if (!container) return;
    const renderers = {
        tap: renderTapScreen, 
        cards: renderCardsScreen, 
        missions: renderMissionsScreen,
        media: renderMediaScreen, 
        party: renderPartyScreen, 
        store: renderStoreScreen,
        leaderboard: renderLeaderboardScreen,
    };
    if (renderers[activeTab]) {
        container.innerHTML = renderers[activeTab]();
    }
    
    // Re-attach event listeners for tap button
    if (activeTab === 'tap') {
        const tapButton = document.getElementById('tapButton');
        if (tapButton) {
            // Remove existing listeners to avoid duplicates
            tapButton.replaceWith(tapButton.cloneNode(true));
            // Get the new button reference
            const newTapButton = document.getElementById('tapButton');
            newTapButton.addEventListener('click', handleTap);
            newTapButton.addEventListener('touchstart', handleTap, { passive: false });
        }
    }
};

const renderHeader = () => {
    const pph = calculatePPH(gameState);
    const energyPercentage = (gameState.energy / ENERGY_MAX) * 100;
    document.getElementById('header').innerHTML = `
        <div class="flex justify-around text-center">
            <div><p class="text-2xl font-extrabold text-yellow-400">${formatNumber(gameState.coins)}</p><p class="text-xs text-gray-400">Funds üí∞</p></div>
            <div><p class="text-2xl font-extrabold text-purple-400">${formatNumber(gameState.influenceTokens)}</p><p class="text-xs text-gray-400">Tokens üíé</p></div>
            <div><p class="text-2xl font-extrabold text-green-400">${formatNumber(calculateTCI(gameState))}</p><p class="text-xs text-gray-400">Influence üìà</p></div>
        </div>
        <div class="bg-slate-900/50 rounded-lg p-2 mt-3">
            <div class="flex justify-between items-center text-sm mb-2 px-1">
                <div class="text-center"><p class="text-blue-400 font-bold">+${formatNumber(calculateTapPower(gameState))}</p><p class="text-gray-400 text-xs">Tap Power</p></div>
                <div class="text-center"><p class="text-green-400 font-bold">${formatNumber(pph)}/hr</p><p class="text-gray-400 text-xs">PPH</p></div>
                <div class="text-center"><p class="text-purple-400 font-bold">${gameState.userCards.filter(c=>c.activated).length}</p><p class="text-gray-400 text-xs">Active</p></div>
            </div>
            <div>
                <div class="flex justify-between text-xs mb-1 px-1"><span class="text-yellow-400 font-bold">‚ö° Energy</span><span class="text-gray-300">${Math.floor(gameState.energy)}/${ENERGY_MAX}</span></div>
                <div class="w-full h-2 bg-slate-700 rounded-full overflow-hidden"><div class="h-full bg-yellow-400 transition-all duration-300" style="width: ${energyPercentage}%"></div></div>
            </div>
        </div>
        ${gameState.combo > 2 ? `<div class="text-center font-bold text-lg text-yellow-300 mt-2 animate-pulse">${gameState.combo}x Combo!</div>` : ''}
    `;
};

const renderNav = () => {
    const navItems = [
        { tab: 'tap', icon: 'üëÜ', label: 'Tap' }, 
        { tab: 'cards', icon: 'üé¥', label: 'Cards' },
        { tab: 'missions', icon: 'üìã', label: 'Missions' }, 
        { tab: 'media', icon: 'üì∫', label: 'Media' },
        { tab: 'party', icon: 'üèõÔ∏è', label: 'Party' }, 
        { tab: 'store', icon: 'üíé', label: 'Store' },
        { tab: 'leaderboard', icon: 'üèÜ', label: 'Rank' },
    ];
    document.querySelector('nav').innerHTML = navItems.map(({ tab, icon, label }) => `
        <button data-tab="${tab}" class="nav-item flex-1 flex flex-col items-center p-2 rounded-lg transition-colors ${activeTab === tab ? 'active' : 'text-gray-400'}">
            <span class="text-2xl">${icon}</span><span class="text-xs mt-1">${label}</span>
        </button>
    `).join('');
};

const renderTapScreen = () => {
    const isBoostActive = gameState.activeBoosts.some(b => b.multiplier > 1);
    const progressPercent = Math.min(100, (gameState.dailyTaps / DAILY_GOAL) * 100);
    return `
    <div class="relative mb-8 mt-4">
        <button id="tapButton" class="w-[230px] h-[230px] rounded-full flex flex-col justify-center items-center text-white font-black text-4xl shadow-lg active:scale-95 transition-transform select-none ${isBoostActive ? 'boost-active' : ''}">
            Tap! <span class="text-3xl mt-1">+${formatNumber(calculateTapPower(gameState))}</span>
        </button>
    </div>
    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl p-3 w-full max-w-sm mb-4">
        <div class="flex justify-between items-center">
            <div><p class="font-bold text-lg">${gameState.streak} Day Streak</p><p class="text-xs text-yellow-300">Tap Power Bonus: +${STREAK_BONUS[gameState.streak || 0]}%</p></div>
        </div>
    </div>
    <div class="w-full max-w-sm p-4 bg-slate-800/80 rounded-xl border border-slate-700/50">
        <h3 class="font-bold text-lg text-blue-300 mb-2">Daily Goal (${DAILY_GOAL} Taps)</h3>
        <p class="text-sm text-gray-400 mb-2 flex justify-between">
            <span>Progress: ${gameState.dailyTaps}/${DAILY_GOAL}</span>
            <span class="text-yellow-400">+${formatNumber(DAILY_REWARD_COINS)}üí∞ & +${DAILY_REWARD_TOKENS}üíé</span>
        </p>
        <div class="w-full bg-gray-700 rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full" style="width: ${progressPercent}%"></div></div>
    </div>
    `;
};

// ‚úÖ FIXED: renderCardsScreen with proper asset paths and functionality
const renderCardsScreen = () => {
    return `
    <h2 class="text-2xl font-bold text-center mb-4 text-yellow-400">Candidate Cards</h2>
    <div class="space-y-4">
        ${GAME_CONFIG.candidates.map(candidate => {
            const userCard = gameState.userCards.find(c => c.id === candidate.id);
            const isActive = candidate.active;
            const cardClass = userCard ? 
                (userCard.activated ? 'border-green-400 bg-slate-800' : 'border-slate-600 bg-slate-800/70') : 
                'border-slate-700 bg-slate-800/50';
            const finalCardClass = isActive ? cardClass : 'border-slate-700 bg-slate-900/60 filter-grayscale';
            const upgradeCost = userCard ? candidate.bid * userCard.level * 1.5 : 0;
            
            return `
            <div class="p-4 rounded-xl border-2 relative ${finalCardClass}">
                ${candidate.sponsored && isActive ? 
                    `<div class="absolute top-2 right-2 text-xs bg-yellow-500 text-black font-bold px-2 py-0.5 rounded-full">Sponsored</div>` : 
                    ''}
                <div class="flex gap-4 items-start">
                    <img src="${GITHUB_ASSETS_BASE_URL}photos/${candidate.photo}" alt="${candidate.name}" 
                         class="w-20 h-20 rounded-full object-cover border-4 ${candidate.logoColor}" 
                         onerror="this.src='https://picsum.photos/seed/${candidate.id}/100/100'" />
                    <div class="flex-1">
                        <div class="flex justify-between">
                            <h3 class="font-bold text-lg">${candidate.name}</h3>
                            ${userCard ? `<p class="font-bold text-yellow-400">Lv. ${userCard.level}</p>` : ''}
                        </div>
                        <p class="text-sm text-gray-400">${GAME_CONFIG.parties[candidate.party]?.name || 'Unknown Party'}</p>
                        <p class="text-xs text-gray-300 mt-1">PPH: +${formatNumber(candidate.profitPerHour * (userCard ? userCard.level : 1))}</p>
                    </div>
                </div>
                <div class="flex justify-between mt-4 gap-2">
                    ${userCard ? `
                        <button data-action="toggleActivateCard" data-id="${candidate.id}" 
                                class="w-1/2 py-2 rounded font-bold text-white ${userCard.activated ? 'bg-yellow-600 hover:bg-yellow-500' : 'bg-green-600 hover:bg-green-500'}">
                            ${userCard.activated ? 'Deactivate' : 'Activate'}
                        </button>
                        <button data-action="upgradeCard" data-id="${candidate.id}" 
                                class="w-1/2 bg-blue-600 hover:bg-blue-500 py-2 rounded font-bold text-white disabled:bg-gray-500" 
                                ${!isActive || gameState.coins < upgradeCost ? 'disabled' : ''}>
                            Upgrade (${formatNumber(upgradeCost)}üí∞)
                        </button>
                    ` : `
                        <button data-action="buyCard" data-id="${candidate.id}" 
                                class="w-full bg-purple-600 hover:bg-purple-500 py-2 rounded font-bold text-white disabled:bg-gray-500 disabled:cursor-not-allowed" 
                                ${!isActive || gameState.coins < candidate.bid ? 'disabled' : ''}>
                            ${isActive ? `Buy (${formatNumber(candidate.bid)}üí∞)` : '<i class="fa fa-lock mr-2"></i> Unavailable'}
                        </button>
                    `}
                </div>
                ${!isActive ? `<p class="text-xs text-red-400 mt-2 text-center">Card inactive. Contact admin to activate.</p>` : ''}
            </div>`;
        }).join('')}
    </div>`;
};

// ‚úÖ FIXED: renderMissionsScreen with complete implementation
const renderMissionsScreen = () => {
    return `
    <h2 class="text-2xl font-bold text-center mb-4 text-yellow-400">Daily Missions</h2>
    <div class="space-y-3">
        ${DAILY_MISSIONS.map(mission => {
            const progress = gameState.missionProgress[mission.id]?.progress || 0;
            const isCompleted = gameState.completedMissions.includes(mission.id);
            const percent = isCompleted ? 100 : Math.min(100, (progress / mission.target) * 100);
            return `
            <div class="bg-slate-800 p-4 rounded-lg ${isCompleted ? 'opacity-60' : ''}">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-white">${mission.title}</h4>
                    <span class="text-yellow-400 font-bold">+${formatNumber(mission.reward)} üí∞</span>
                </div>
                <p class="text-sm text-gray-400 mb-3">${mission.description}</p>
                <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: ${percent}%"></div>
                </div>
                <div class="text-right text-xs mt-1 text-gray-300">
                    ${isCompleted ? 'Completed' : `${formatNumber(progress)} / ${formatNumber(mission.target)}`}
                </div>
            </div>`;
        }).join('')}
    </div>`;
};

// ‚úÖ FIXED: renderMediaScreen with proper asset paths
const renderMediaScreen = () => {
    const activeCandidates = GAME_CONFIG.candidates.filter(c => c.active);
    const activeParties = Object.entries(GAME_CONFIG.parties).filter(([id, p]) => p.active);

    const candidateMedia = activeCandidates.map(c => `
        <div class="bg-slate-800 p-4 rounded-xl flex gap-4 items-center">
             <img src="${GITHUB_ASSETS_BASE_URL}photos/${c.photo}" alt="${c.name}" 
                  class="w-24 h-24 rounded-lg object-cover"
                  onerror="this.src='https://picsum.photos/seed/c${c.id}/100/100'" />
             <div class="flex-1">
                <h3 class="font-bold text-lg">${c.name}</h3>
                <p class="text-sm text-gray-400 mb-2">${c.bio || 'No biography available.'}</p>
                <button data-action="watchVideo" data-type="candidate" data-id="${c.id}" 
                        class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded text-sm disabled:bg-gray-500" 
                        ${gameState.watchedVideos['c' + c.id] ? 'disabled' : ''}>
                    ${gameState.watchedVideos['c' + c.id] ? 'Watched' : `Watch Video (+${formatNumber(c.videoReward)}üí∞)`}
                </button>
             </div>
        </div>`).join('');

    const partyMedia = activeParties.map(([id, p]) => `
         <div class="bg-slate-800 p-4 rounded-xl flex gap-4 items-center">
             <img src="${GITHUB_ASSETS_BASE_URL}logos/${p.logo}" alt="${p.name}" 
                  class="w-24 h-24 rounded-lg object-contain p-2 bg-slate-700"
                  onerror="this.src='https://picsum.photos/seed/p${id}/100/100'" />
             <div class="flex-1">
                <h3 class="font-bold text-lg">${p.name}</h3>
                <p class="text-sm text-gray-400 mb-2">${p.description}</p>
                <button data-action="watchVideo" data-type="party" data-id="${id}" 
                        class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded text-sm disabled:bg-gray-500" 
                        ${gameState.watchedVideos['p' + id] ? 'disabled' : ''}>
                    ${gameState.watchedVideos['p' + id] ? 'Watched' : `Watch Video (+${formatNumber(p.videoReward)}üí∞)`}
                </button>
             </div>
        </div>`).join('');

    return `
    <h2 class="text-2xl font-bold text-center mb-4 text-yellow-400">Campaign Media</h2>
    <div class="space-y-4">
        <h3 class="font-bold text-lg text-blue-300">Candidates</h3>
        ${candidateMedia || '<p class="text-gray-400 text-sm">No active candidate media available.</p>'}
        <h3 class="font-bold text-lg text-blue-300 mt-4">Parties</h3>
        ${partyMedia || '<p class="text-gray-400 text-sm">No active party media available.</p>'}
    </div>`;
};

// ‚úÖ FIXED: renderPartyScreen with proper functionality
const renderPartyScreen = () => {
    return `
    <h2 class="text-2xl font-bold text-center mb-4 text-yellow-400">Political Parties</h2>
    <div class="space-y-4">
        ${Object.entries(GAME_CONFIG.parties).map(([id, party]) => {
            if (!party.active) {
                return `
                <div class="p-4 rounded-xl border border-slate-700 bg-slate-900/60 filter-grayscale">
                    <div class="flex gap-4 items-center">
                        <img src="${GITHUB_ASSETS_BASE_URL}logos/${party.logo}" alt="${party.name}" 
                             class="w-16 h-16 rounded-full object-contain p-1 border-4 border-slate-600 bg-slate-700"
                             onerror="this.src='https://picsum.photos/seed/party${id}/80/80'" />
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-gray-500">${party.name}</h3>
                            <p class="text-sm text-gray-600">This party is currently inactive.</p>
                        </div>
                    </div>
                </div>`;
            }
            
            const partyState = gameState.parties[id] || { level: 1, xp: 0 };
            const xpPercent = (partyState.xp / (partyState.level * 500)) * 100;
            const upgradeCost = partyState.level * 5;
            
            return `
            <div class="p-4 rounded-xl border border-slate-700 ${party.color || 'bg-slate-800'}">
                <div class="flex gap-4 items-center">
                    <img src="${GITHUB_ASSETS_BASE_URL}logos/${party.logo}" alt="${party.name}" 
                         class="w-16 h-16 rounded-full object-contain p-1 border-4 border-slate-400 bg-slate-800"
                         onerror="this.src='https://picsum.photos/seed/party${id}/80/80'" />
                    <div class="flex-1">
                        <h3 class="font-bold text-lg">${party.name}</h3>
                        <p class="text-sm text-gray-200">Level ${partyState.level}</p>
                    </div>
                </div>
                <p class="text-sm text-gray-200 my-3">${party.description}</p>
                <div class="text-xs text-gray-200">XP: ${formatNumber(partyState.xp)} / ${formatNumber(partyState.level * 500)}</div>
                <div class="w-full bg-gray-600 rounded-full h-2 mb-3">
                    <div class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: ${xpPercent}%"></div>
                </div>
                <div class="flex gap-2">
                    <button data-action="investParty" data-id="${id}" 
                            class="w-1/2 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded">
                        Invest (1küí∞)
                    </button>
                    <button data-action="upgradeParty" data-id="${id}" 
                            class="w-1/2 bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 rounded disabled:bg-gray-500" 
                            ${gameState.influenceTokens < upgradeCost ? 'disabled' : ''}>
                        Upgrade (${upgradeCost}üíé)
                    </button>
                </div>
            </div>`;
        }).join('')}
    </div>`;
};

// ‚úÖ FIXED: renderStoreScreen with complete implementation
const renderStoreScreen = () => {
    return `
    <h2 class="text-2xl font-bold text-center mb-4 text-yellow-400">Campaign Store</h2>
    <div class="space-y-4">
        <div>
            <h3 class="font-bold text-lg text-blue-300 mb-2">Staff</h3>
            ${GAME_CONFIG.managers.map(manager => `
            <div class="bg-slate-800 p-4 rounded-lg flex items-center justify-between mb-2">
                <div>
                    <h4 class="font-bold text-white"><span class="text-2xl">${manager.icon}</span> ${manager.name}</h4>
                    <p class="text-sm text-gray-400">${manager.description}</p>
                </div>
                <button data-action="buyManager" data-id="${manager.id}" 
                        class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded disabled:bg-gray-500" 
                        ${gameState.managerCards.includes(manager.id) || gameState.coins < manager.cost ? 'disabled' : ''}>
                    ${gameState.managerCards.includes(manager.id) ? 'Hired' : `Hire (${formatNumber(manager.cost)}üí∞)`}
                </button>
            </div>`).join('')}
        </div>
        <div>
            <h3 class="font-bold text-lg text-purple-400 mb-2">Boosts</h3>
            ${BOOSTS.map(boost => `
            <div class="bg-slate-800 p-4 rounded-lg flex items-center justify-between mb-2">
                <div>
                    <h4 class="font-bold text-white"><span class="text-2xl">${boost.icon}</span> ${boost.name}</h4>
                    <p class="text-sm text-gray-400">${boost.duration > 0 ? `${boost.duration} seconds` : 'Instant effect'}</p>
                </div>
                <button data-action="activateBoost" data-id="${boost.id}" 
                        class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded disabled:bg-gray-500" 
                        ${gameState.coins < boost.cost ? 'disabled' : ''}>
                    Activate (${formatNumber(boost.cost)}üí∞)
                </button>
            </div>`).join('')}
        </div>
    </div>`;
};

// ‚úÖ FIXED: renderLeaderboardScreen with complete implementation
const renderLeaderboardScreen = () => {
    let leaderboardData = {};
    try {
        leaderboardData = JSON.parse(localStorage.getItem('campaignLeaderboard') || '{}');
    } catch (e) {
        console.warn("Could not load leaderboard data", e);
    }
    
    const leaderboardArray = Object.values(leaderboardData).sort((a, b) => b.score - a.score);
    const topPlayers = leaderboardArray.slice(0, 10);
    
    return `
    <h2 class="text-2xl font-bold text-center mb-4 text-yellow-400">Leaderboard</h2>
    <div class="space-y-2">
        ${topPlayers.map((player, index) => `
        <div class="flex items-center bg-slate-800 p-3 rounded-lg ${player.username === (telegramUser?.username || gameState.telegramUsername) ? 'border-2 border-blue-500' : ''}">
            <div class="text-lg font-bold w-8 text-center text-gray-400">${index + 1}</div>
            <div class="font-bold flex-1">${player.username}</div>
            <div class="font-bold text-yellow-400">${formatNumber(player.score)} TCI</div>
        </div>
        `).join('')}
    </div>
    <div class="mt-4 p-4 bg-slate-800 rounded-lg">
        <h3 class="font-bold text-lg mb-2">Your Stats</h3>
        <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="bg-slate-700 p-2 rounded">Total Taps: ${formatNumber(gameState.totalTaps)}</div>
            <div class="bg-slate-700 p-2 rounded">Lifetime Funds: ${formatNumber(gameState.totalLifetimeCoins)}</div>
            <div class="bg-slate-700 p-2 rounded">Cards Owned: ${gameState.userCards.length}</div>
            <div class="bg-slate-700 p-2 rounded">Achievements: ${gameState.achievements.length}/${ACHIEVEMENTS.length}</div>
        </div>
    </div>`;
};

const renderModal = (title, content, showClose = true) => {
    document.getElementById('modalContainer').innerHTML = `
        <div data-action="closeModal" class="modal-overlay"></div>
        <div class="modal bg-slate-800 w-[90%] max-w-lg rounded-xl p-6 border-2 border-blue-500 shadow-lg">
            <h2 class="text-2xl font-bold text-center mb-4 text-yellow-400">${title}</h2>
            <div>${content}</div>
            ${showClose ? `<button data-action="closeModal" class="w-full mt-6 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded">Close</button>` : ''}
        </div>`;
};

const closeModal = () => {
    document.getElementById('modalContainer').innerHTML = '';
};

// ‚úÖ FIXED: renderAdminPanelContent with complete implementation
const renderAdminPanelContent = () => {
    const candidateListHtml = GAME_CONFIG.candidates.map(candidate => `
        <div class="flex items-center justify-between p-3 bg-slate-900 rounded-lg mb-2">
            <div class="flex-1">
                <div class="flex items-center">
                    <img src="${GITHUB_ASSETS_BASE_URL}photos/${candidate.photo}" alt="${candidate.name}" 
                         class="w-10 h-10 rounded-full mr-3 object-cover"
                         onerror="this.src='https://picsum.photos/seed/c${candidate.id}/50/50'">
                    <div>
                        <span class="font-bold ${candidate.active ? 'text-green-400' : 'text-red-400'}">${candidate.name}</span>
                        <div class="text-xs text-gray-400">
                            ${candidate.active ? 'üü¢ Active' : 'üî¥ Inactive'} 
                            ${candidate.sponsored ? ' | ‚≠ê Sponsored' : ''}
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex space-x-2">
                <button data-action="adminToggleActive" data-type="candidate" data-id="${candidate.id}" 
                        class="text-xs py-2 px-3 rounded font-bold ${candidate.active ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'} text-white">
                    ${candidate.active ? 'Deactivate' : 'Activate'}
                </button>
                <button data-action="adminToggleSponsor" data-id="${candidate.id}" 
                        class="text-xs py-2 px-3 rounded font-bold ${candidate.sponsored ? 'bg-purple-600 hover:bg-purple-700' : 'bg-gray-600 hover:bg-gray-700'} text-white">
                    ${candidate.sponsored ? 'Unsponsor' : 'Sponsor'}
                </button>
            </div>
        </div>`).join('');

    const partyListHtml = Object.entries(GAME_CONFIG.parties).map(([id, party]) => `
         <div class="flex items-center justify-between p-3 bg-slate-900 rounded-lg mb-2">
            <div class="flex-1">
                <div class="flex items-center">
                    <img src="${GITHUB_ASSETS_BASE_URL}logos/${party.logo}" alt="${party.name}" 
                         class="w-10 h-10 rounded-full mr-3 object-contain bg-slate-700 p-1"
                         onerror="this.src='https://picsum.photos/seed/p${id}/50/50'">
                    <div>
                        <span class="font-bold ${party.active ? 'text-green-400' : 'text-red-400'}">${party.name}</span>
                        <div class="text-xs text-gray-400">${party.active ? 'üü¢ Active' : 'üî¥ Inactive'}</div>
                    </div>
                </div>
            </div>
            <div class="flex space-x-2">
                <button data-action="adminToggleActive" data-type="party" data-id="${id}" 
                        class="text-xs py-2 px-3 rounded font-bold ${party.active ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'} text-white">
                    ${party.active ? 'Deactivate' : 'Activate'}
                </button>
            </div>
        </div>`).join('');

    const userInfoHtml = telegramUser ? `
        <div class="bg-green-900/30 p-4 rounded-lg mb-4">
            <h3 class="font-bold text-green-300 mb-2">üë§ Telegram User Info</h3>
            <div class="space-y-1 text-sm">
                <div><span class="text-gray-400">Username:</span> @${telegramUser.username || 'N/A'}</div>
                <div><span class="text-gray-400">Name:</span> ${telegramUser.first_name || ''} ${telegramUser.last_name || ''}</div>
                <div><span class="text-gray-400">ID:</span> ${telegramUser.id}</div>
                <div><span class="text-gray-400">Language:</span> ${telegramUser.language_code || 'N/A'}</div>
            </div>
        </div>
    ` : '';

    return `
        <div class="text-left max-h-[70vh] overflow-y-auto pr-2">
            <!-- User Information -->
            ${userInfoHtml}
            
            <!-- Contact Information -->
            <div class="bg-blue-900/30 p-4 rounded-lg mb-4">
                <h3 class="font-bold text-blue-300 mb-2">üìû Contact & Pricing</h3>
                <div class="space-y-2 text-sm">
                    <div><span class="text-gray-400">Telegram:</span> ${ADMIN_CONTACT.telegram}</div>
                    <div><span class="text-gray-400">Email:</span> ${ADMIN_CONTACT.email}</div>
                    <div><span class="text-gray-400">Phone:</span> ${ADMIN_CONTACT.phone}</div>
                    <div class="mt-2 p-2 bg-yellow-900/30 rounded">
                        <p class="text-yellow-300 font-bold mb-1">üí∞ Activation Pricing:</p>
                        <p class="text-xs">Candidate: ${ADMIN_CONTACT.pricing.candidate}</p>
                        <p class="text-xs">Party: ${ADMIN_CONTACT.pricing.party}</p>
                        <p class="text-xs">Sponsorship: ${ADMIN_CONTACT.pricing.sponsorship}</p>
                    </div>
                </div>
            </div>

            <!-- About Section -->
            <div class="bg-purple-900/30 p-4 rounded-lg mb-4">
                <h3 class="font-bold text-purple-300 mb-2">‚ÑπÔ∏è About</h3>
                <p class="text-sm text-gray-300 mb-2">Supreme Strategic Campaign Simulator - Iraq</p>
                <p class="text-xs text-gray-400">Version: ${gameState.appVersion}</p>
                <p class="text-xs text-gray-400 mt-2">${ADMIN_CONTACT.instructions}</p>
            </div>
            
            <!-- Candidate Management -->
            <div class="mb-4">
                <h4 class="font-bold text-blue-400 mb-2 flex items-center">
                    <i class="fa fa-users mr-2"></i> Candidate Management (${GAME_CONFIG.candidates.length})
                </h4>
                <div id="candidateActivationList" class="space-y-2">${candidateListHtml}</div>
            </div>
            
            <hr class="my-4 border-slate-600">
            
            <!-- Party Management -->
            <div class="mb-4">
                <h4 class="font-bold text-green-400 mb-2 flex items-center">
                    <i class="fa fa-flag mr-2"></i> Party Management (${Object.keys(GAME_CONFIG.parties).length})
                </h4>
                <div id="partyActivationList" class="space-y-2">${partyListHtml}</div>
            </div>
            
            <hr class="my-4 border-slate-600">
            
            <!-- Admin Actions -->
            <div class="mb-4">
                <h4 class="font-bold text-yellow-400 mb-2">‚öôÔ∏è Admin Actions</h4>
                <div class="grid grid-cols-2 gap-2">
                    <button data-action="adminAddCoins" class="bg-green-600 hover:bg-green-700 text-white py-2 rounded text-sm font-bold">
                        Add 10K Coins
                    </button>
                    <button data-action="adminResetGame" class="bg-red-600 hover:bg-red-700 text-white py-2 rounded text-sm font-bold">
                        Reset Game
                    </button>
                    <button data-action="adminExportData" class="bg-purple-600 hover:bg-purple-700 text-white py-2 rounded text-sm font-bold col-span-2">
                        Export Game Data
                    </button>
                    <button data-action="adminResetConfig" class="bg-orange-600 hover:bg-orange-700 text-white py-2 rounded text-sm font-bold col-span-2">
                        Reset Config to Default
                    </button>
                </div>
            </div>

            <!-- Game Statistics -->
            <div class="bg-slate-900 p-3 rounded-lg">
                <h4 class="font-bold text-gray-300 mb-2">üìä Game Stats</h4>
                <div class="grid grid-cols-2 gap-1 text-xs">
                    <div class="text-gray-400">Total Players:</div>
                    <div class="text-right">${Object.keys(JSON.parse(localStorage.getItem('campaignLeaderboard') || '{}')).length}</div>
                    <div class="text-gray-400">Your TCI:</div>
                    <div class="text-right">${formatNumber(gameState.totalCampaignInfluence)}</div>
                    <div class="text-gray-400">Your Coins:</div>
                    <div class="text-right">${formatNumber(gameState.coins)}</div>
                    <div class="text-gray-400">Active Cards:</div>
                    <div class="text-right">${gameState.userCards.filter(c => c.activated).length}</div>
                </div>
            </div>
        </div>
    `;
};

// ‚úÖ FIXED: handleAction with complete implementations for all actions
const handleAction = (e) => {
    const target = e.target.closest('[data-action]');
    if (!target) return;

    const { action, id, type } = target.dataset;
    const actions = {
        closeModal,
        buyCard: () => {
            const c = GAME_CONFIG.candidates.find(c => c.id == id);
            if (c && c.active && gameState.coins >= c.bid) {
                gameState.coins -= c.bid;
                gameState.userCards.push({ id: parseInt(id), level: 1, activated: false });
                showMessage(`Hired ${c.name}!`, 'success');
                checkAchievements();
                updateAll();
            } else if (!c.active) {
                showMessage("This candidate is not active!", "error");
            } else {
                showMessage("Not enough coins!", "error");
            }
        },
        upgradeCard: () => {
            const uc = gameState.userCards.find(uc => uc.id == id);
            if(uc) {
                const c = GAME_CONFIG.candidates.find(c => c.id == id);
                const cost = c.bid * uc.level * 1.5;
                if (gameState.coins >= cost) {
                    gameState.coins -= cost;
                    uc.level++;
                    showMessage(`${c.name} upgraded to Lv.${uc.level}!`, 'success');
                    checkMissionProgress('level', uc.level);
                    updateAll();
                } else {
                    showMessage("Not enough coins!", "error");
                }
            }
        },
        toggleActivateCard: () => {
            const uc = gameState.userCards.find(uc => uc.id == id);
            if (uc) {
                uc.activated = !uc.activated;
                showMessage(`${GAME_CONFIG.candidates.find(c => c.id == id)?.name} ${uc.activated ? 'activated' : 'deactivated'}!`, 'success');
                updateAll();
            }
        },
        watchVideo: () => {
            const item = type === 'candidate' ? GAME_CONFIG.candidates.find(c => c.id == id) : GAME_CONFIG.parties[id];
            const watchId = (type === 'candidate' ? 'c' : 'p') + id;
            if (item && !gameState.watchedVideos[watchId]) {
                const videoUrl = item.promoVideo.replace("watch?v=", "embed/");
                const content = `
                    <div class="aspect-w-16 aspect-h-9">
                        <iframe src="${videoUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-64 rounded"></iframe>
                    </div>
                    <button data-action="claimVideoReward" data-type="${type}" data-id="${id}" class="w-full mt-4 bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded">Claim Reward & Close</button>
                `;
                renderModal(`${item.name} - Campaign Video`, content, false);
            } else {
                showMessage("You've already watched this video!", "info");
            }
        },
        claimVideoReward: () => {
            const item = type === 'candidate' ? GAME_CONFIG.candidates.find(c => c.id == id) : GAME_CONFIG.parties[id];
            const watchId = (type === 'candidate' ? 'c' : 'p') + id;
            if (item && !gameState.watchedVideos[watchId]) {
                gameState.coins += item.videoReward;
                gameState.totalLifetimeCoins += item.videoReward;
                gameState.watchedVideos[watchId] = true;
                showMessage(`Watched video, +${formatNumber(item.videoReward)}üí∞!`, 'success');
                closeModal();
                updateAll();
            }
        },
        investParty: () => {
            const partyState = gameState.parties[id];
            if (partyState && gameState.coins >= 1000) {
                gameState.coins -= 1000;
                partyState.xp += 100;
                partyState.totalInvestment += 1000;
                if(partyState.xp >= partyState.level * 500) {
                    partyState.xp -= partyState.level * 500;
                    partyState.level++;
                    showMessage(`${GAME_CONFIG.parties[id].name} leveled up to Lv.${partyState.level}!`, 'success');
                }
                updateAll();
            } else {
                showMessage("Not enough coins!", "error");
            }
        },
        upgradeParty: () => {
            const partyState = gameState.parties[id];
            const cost = partyState.level * 5;
            if(partyState && gameState.influenceTokens >= cost) {
                gameState.influenceTokens -= cost;
                partyState.level++;
                showMessage(`${GAME_CONFIG.parties[id].name} upgraded to Lv.${partyState.level}!`, 'success');
                updateAll();
            } else {
                showMessage("Not enough influence tokens!", "error");
            }
        },
        buyManager: () => {
            const m = GAME_CONFIG.managers.find(m => m.id === id);
            if(m && gameState.coins >= m.cost && !gameState.managerCards.includes(id)) {
                gameState.coins -= m.cost;
                gameState.managerCards.push(id);
                showMessage(`Hired ${m.name}!`, 'success');
                updateAll();
            } else if (gameState.managerCards.includes(id)) {
                showMessage("You already hired this manager!", "info");
            } else {
                showMessage("Not enough coins!", "error");
            }
        },
        activateBoost: () => {
            const b = BOOSTS.find(b => b.id === id);
            if(b && gameState.coins >= b.cost) {
                gameState.coins -= b.cost;
                if(b.energy) {
                    gameState.energy = Math.min(ENERGY_MAX, gameState.energy + b.energy);
                    showMessage(`${b.name} activated! Energy restored.`, 'success');
                }
                if(b.duration > 0) {
                    gameState.activeBoosts.push({ 
                        id, 
                        endTime: Date.now() + b.duration * 1000, 
                        multiplier: b.multiplier 
                    });
                    showMessage(`${b.name} activated for ${b.duration} seconds!`, 'success');
                }
                updateAll();
            } else {
                showMessage("Not enough coins!", "error");
            }
        },
        adminToggleActive: () => {
            const item = type === 'candidate' ? 
                GAME_CONFIG.candidates.find(c => c.id == id) : 
                GAME_CONFIG.parties[id];
            if (item) {
                item.active = !item.active;
                const action = item.active ? 'activated' : 'deactivated';
                showMessage(`${item.name} ${action} successfully!`, 'success');
                saveConfigChanges();
                renderModal('Admin Panel', renderAdminPanelContent());
                updateAll();
            }
        },
        adminToggleSponsor: () => {
            const c = GAME_CONFIG.candidates.find(c => c.id == id);
            if (c) {
                c.sponsored = !c.sponsored;
                const action = c.sponsored ? 'sponsored' : 'unsponsored';
                showMessage(`${c.name} ${action} successfully!`, 'success');
                saveConfigChanges();
                renderModal('Admin Panel', renderAdminPanelContent());
                updateAll();
            }
        },
        adminAddCoins: () => {
            gameState.coins += 10000;
            gameState.totalLifetimeCoins += 10000;
            showMessage('Added 10,000 coins!', 'success');
            renderModal('Admin Panel', renderAdminPanelContent());
            updateAll();
        },
        adminResetGame: () => {
            if (confirm("Are you sure you want to reset the game? All progress will be lost!")) {
                gameState = createDefaultGameState();
                showMessage("Game reset successfully", 'success');
                renderModal('Admin Panel', renderAdminPanelContent());
                updateAll();
            }
        },
        adminExportData: () => {
            try {
                const dataStr = JSON.stringify({
                    gameState: gameState,
                    config: GAME_CONFIG,
                    leaderboard: JSON.parse(localStorage.getItem('campaignLeaderboard') || '{}'),
                    exportDate: new Date().toISOString()
                }, null, 2);
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `campaign-data-${getTodayString()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showMessage('Game data exported successfully!', 'success');
            } catch (e) {
                showMessage('Failed to export data.', 'error');
                console.error(e);
            }
        },
        adminResetConfig: () => {
            if (confirm("Are you sure you want to reset the configuration to default? This will remove all your activation changes and reload from the external source.")) {
                try {
                    localStorage.removeItem('campaignConfig');
                    showMessage("Configuration reset successfully. Reloading...", 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } catch (e) {
                    showMessage('Failed to reset configuration.', 'error');
                    console.error(e);
                }
            }
        }
    };

    if (actions[action]) {
        actions[action]();
    } else {
        console.warn('Unknown action:', action);
    }
};

const initTelegram = () => {
    if (window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.expand();
        telegramUser = tg.initDataUnsafe?.user || null;
        
        if (telegramUser) {
            console.log("Telegram user detected:", telegramUser);
            gameState.telegramUsername = telegramUser.username || `user_${telegramUser.id}`;
            gameState.telegramId = telegramUser.id;
            gameState.telegramFirstName = telegramUser.first_name || '';
            gameState.telegramLastName = telegramUser.last_name || '';
        }
    } else {
        console.log("Running outside Telegram, using test mode");
        telegramUser = { 
            id: Math.floor(Math.random() * 1000000), 
            username: 'test_user_' + Math.random().toString(36).substr(2, 5),
            first_name: 'Test',
            last_name: 'User',
            language_code: 'en'
        };
        gameState.telegramUsername = telegramUser.username;
        gameState.telegramId = telegramUser.id;
        gameState.telegramFirstName = telegramUser.first_name;
        gameState.telegramLastName = telegramUser.last_name;
    }
};

const initGame = async () => {
    await loadExternalConfig();
    loadGameState();
    initTelegram();

    // --- üîí ADMIN SECURITY CHECK ---
    const adminButton = document.getElementById('adminToggle');
    if ((telegramUser && telegramUser.id === YOUR_ADMIN_TELEGRAM_ID) || 
        (YOUR_ADMIN_TELEGRAM_ID === 123456789 && !window.Telegram?.WebApp)) {
        console.log("ADMIN ACCESS GRANTED");
        adminButton.style.display = 'flex';
    } else {
        console.log("Standard user access. Admin panel hidden.");
        adminButton.style.display = 'none';
    }
    // --- END SECURITY CHECK ---

    // Energy regeneration interval
    setInterval(() => {
        if (!gameState) return;
        const now = Date.now();
        const timePassed = (now - gameState.lastEnergyUpdate) / 1000;
        gameState.energy = Math.min(ENERGY_MAX, gameState.energy + timePassed * ENERGY_REGEN_RATE);
        gameState.lastEnergyUpdate = now;
        
        // Filter expired boosts
        gameState.activeBoosts = gameState.activeBoosts.filter(b => b.endTime > now);
        renderHeader();
    }, 1000);

    // Auto-save every 30 seconds
    setInterval(saveGameState, 30000);

    // Event delegation for all dynamic buttons
    document.body.addEventListener('click', (e) => {
        handleAction(e);
        const navButton = e.target.closest('[data-tab]');
        if (navButton) navigate(navButton.dataset.tab);
    });

    // Admin button listener
    adminButton.addEventListener('click', () => {
        renderModal('Admin Panel', renderAdminPanelContent());
    });
    
    // Initialize the game
    navigate('tap');
    updateAll();
    document.getElementById('loadingIndicator').style.display = 'none';
};

initGame();
});
</script>
</body>
</html>
