<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Supreme Strategic Campaign Simulator (Iraq)</title>
    <!-- Tailwind via CDN for ease of use. For production, host locally. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-theme-bg-color: #0f172a;
            --tg-theme-text-color: #f1f5f9;
            --tg-theme-button-color: #3b82f6;
            --tg-theme-button-text-color: #ffffff;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--tg-theme-bg-color) 0%, #1e293b 70%, var(--tg-theme-bg-color) 100%);
            color: var(--tg-theme-text-color);
            overscroll-behavior-y: contain; /* Prevents pull-to-refresh */
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        /* Tap Animation & Feedback */
        .tap-feedback {
            position: absolute; font-size: 2.2rem; font-weight: 900;
            color: #fcd34d; text-shadow: 0 2px 8px #000;
            pointer-events: none; animation: floatup 0.8s ease-out forwards;
            white-space: nowrap; z-index: 100; will-change: transform, opacity;
        }
        @keyframes floatup {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.2); opacity: 0; }
        }
        #tapButton {
            width: 240px; height: 240px;
            background: radial-gradient(circle at center, var(--tg-theme-button-color) 0%, #1e40af 70%, #1e3a8a 100%);
            border: 8px solid #fef3c7;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.5), inset 0 5px 15px rgba(255,255,255,0.2);
            transition: transform 0.05s ease; touch-action: manipulation;
            position: relative; overflow: hidden;
        }
        #tapButton:active { transform: scale(0.96); }
        /* Visual Effects */
        .filter-grayscale { filter: grayscale(100%); opacity: 0.7; }
        .nav-item.active { color: #60a5fa; background: rgba(255,255,255,0.05); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; backdrop-filter: blur(4px); }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1001; max-height: 90vh; overflow-y: auto; }
        .hide { display: none !important; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 pb-28 max-w-md mx-auto min-h-screen relative">

    <!-- Loading Screen -->
    <div id="loadingIndicator" class="fixed inset-0 bg-[#0f172a] z-[2000] flex flex-col justify-center items-center transition-opacity duration-500">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-yellow-400 rounded-full animate-spin mb-4"></div>
        <p class="text-lg font-bold text-gray-300 animate-pulse">Connecting to HQ...</p>
    </div>

    <!-- Toast Messages -->
    <div id="messageBox" class="fixed top-4 left-1/2 -translate-x-1/2 w-[90%] max-w-sm z-[1500] pointer-events-none transition-all duration-300"></div>
    
    <!-- Admin Button - HIDDEN BY DEFAULT via inline style -->
    <button id="adminToggle" style="display: none;" class="fixed top-20 right-4 z-50 bg-slate-800/90 border border-slate-600 text-white w-10 h-10 rounded-full items-center justify-center shadow-xl backdrop-blur-sm active:scale-90 transition-transform">
        <i class="fa fa-lock-open text-yellow-400"></i>
    </button>

    <!-- Sticky Header -->
    <header id="header" class="w-full mb-4 p-3 bg-slate-800/90 backdrop-blur-md rounded-2xl shadow-lg border border-slate-700/50 sticky top-2 z-30">
        <!-- Content rendered by JS -->
    </header>

    <!-- Main Content Area -->
    <main class="w-full flex-grow relative">
        <div id="tap" class="tab-content fade-in"></div>
        <div id="cards" class="tab-content hide"></div>
        <div id="missions" class="tab-content hide"></div>
        <div id="media" class="tab-content hide"></div>
        <div id="party" class="tab-content hide"></div>
        <div id="store" class="tab-content hide"></div>
        <div id="leaderboard" class="tab-content hide"></div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto w-full flex justify-evenly px-2 py-3 border-t border-slate-800/80 bg-[#0f172a]/95 backdrop-blur-lg z-40 pb-safe">
        <!-- Content rendered by JS -->
    </nav>
    
    <!-- Modals -->
    <div id="modalContainer"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

// ==========================================
// 🔒 SECURITY CONFIGURATION
// ==========================================
// REPLACE THIS NUMBER with your personal Telegram User ID.
// Get it from @userinfobot on Telegram.
const YOUR_ADMIN_TELEGRAM_ID = 123456789; // <--- !!! REPLACE WITH YOUR REAL ID !!!
// ==========================================

// --- CONSTANTS & GAME BALANCING ---
const APP_VERSION = '1.3.0-biz';
const CONSTANTS = {
    ENERGY: { MAX: 500, REGEN: 3 }, // Regen per second
    TCI_SCALE: { COINS: 50000, CARD_LVL: 25, PARTY_LVL: 100 },
    TIMERS: { COMBO: 1500, SAVE: 15000, TICK: 1000 },
    DAILY: { TAPS: 1000, COINS: 25000, TOKENS: 5 }
};

const STREAK_BONUS = [0, 5, 10, 20, 35, 50, 75, 100]; // Days 1-7+ (%)

// GitHub Raw URLs for Config (Ensure "active": false is set in these files for your business model)
const CONFIG_URLS = {
    parties: 'https://raw.githubusercontent.com/Yaseen-bnavi/Tap-to-Vote/main/config/parties.json',
    candidates: 'https://raw.githubusercontent.com/Yaseen-bnavi/Tap-to-Vote/main/config/candidates.json',
    managers: 'https://raw.githubusercontent.com/Yaseen-bnavi/Tap-to-Vote/main/config/managers.json'
};

// Admin Contact Info (Display in Admin Panel)
const ADMIN_INFO = {
    contact: '@campaign_admin_iq',
    rates: { candidate: '50K IQD/mo', party: '100K IQD/mo', sponsor: '+50K IQD' }
};

// Static Game Data
const ACHIEVEMENTS = [
    { id: 't1', type: 'totalTaps', thr: 1000, title: "Grassroots", rw: {c: 5000} },
    { id: 'c1', type: 'totalLifetimeCoins', thr: 100000, title: "Fundraiser", rw: {t: 10} },
    { id: 'u1', type: 'ownedCards', thr: 3, title: "Team Builder", rw: {c: 10000} }
];

const DAILY_MISSIONS = [
    { id: 'dm1', type: 'taps', target: 500, reward: 5000, desc: "Tap 500 times" },
    { id: 'dm2', type: 'earn', target: 50000, reward: 10000, desc: "Earn 50K coins" }
];

const BOOSTS = [
    { id: 'x2', name: "2x Power (60s)", cost: 10000, dur: 60, mult: 2, icon: '⚡' },
    { id: 'full', name: "Full Energy", cost: 5000, energy: true, icon: '🔋' }
];

// --- GLOBAL STATE ---
let GAME_CONFIG = { parties: {}, candidates: [], managers: [] };
let gameState = null;
let telegramUser = null;
let activeTab = 'tap';
let msgTimeout;

// --- DOM CACHE ---
const $ = (id) => document.getElementById(id);
const DOM = {
    loader: $('loadingIndicator'), header: $('header'), nav: document.querySelector('nav'),
    modals: $('modalContainer'), msg: $('messageBox'), adminBtn: $('adminToggle'),
    tabs: { tap: $('tap'), cards: $('cards'), missions: $('missions'), media: $('media'), party: $('party'), store: $('store'), leaderboard: $('leaderboard') }
};

// --- UTILITIES ---
const fmt = (n) => {
    if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
    if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
    return Math.floor(n || 0).toString();
};
const todayStr = () => new Date().toISOString().split('T')[0];

const notify = (txt, type = 'info') => {
    clearTimeout(msgTimeout);
    const bg = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
    DOM.msg.innerHTML = `<div class="${bg} text-white text-center font-bold py-2 px-4 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all">${txt}</div>`;
    DOM.msg.style.transform = 'translate(-50%, 0)';
    msgTimeout = setTimeout(() => { DOM.msg.style.transform = 'translate(-50%, -20px)'; DOM.msg.innerHTML = ''; }, 2500);
};

// --- CONFIG & STATE MANAGEMENT ---
const loadConfig = async () => {
    try {
        // 1. Load local overrides (Admin activations)
        const local = JSON.parse(localStorage.getItem('dss_config_overrides') || '{}');
        
        // 2. Fetch remote data
        const fetcher = async (url) => {
            const res = await fetch(`${url}?v=${Date.now()}`); // Cache bust
            return res.ok ? res.json() : null;
        };

        const [p, c, m] = await Promise.all([
            fetcher(CONFIG_URLS.parties),
            fetcher(CONFIG_URLS.candidates),
            fetcher(CONFIG_URLS.managers)
        ]);

        // 3. Merge: Remote Data + Local Admin Overrides
        if (c) GAME_CONFIG.candidates = c.map(cand => ({ ...cand, ...(local.candidates?.[cand.id] || {}) }));
        if (p) GAME_CONFIG.parties = Object.entries(p).reduce((acc, [k, v]) => {
            acc[k] = { ...v, ...(local.parties?.[k] || {}) }; return acc;
        }, {});
        if (m) GAME_CONFIG.managers = m;

    } catch (e) { console.error("Config load error", e); notify("Network error. Using cached config.", 'error'); }
};

const saveAdminOverrides = () => {
    // Saves ONLY activation/sponsor status to localStorage
    const overrides = {
        candidates: GAME_CONFIG.candidates.reduce((acc, c) => {
            if(c.active || c.sponsored) acc[c.id] = { active: c.active, sponsored: c.sponsored };
            return acc;
        }, {}),
        parties: Object.entries(GAME_CONFIG.parties).reduce((acc, [k, v]) => {
            if(v.active) acc[k] = { active: v.active };
            return acc;
        }, {})
    };
    localStorage.setItem('dss_config_overrides', JSON.stringify(overrides));
};

const defaultState = () => ({
    coins: 5000, tokens: 0, totalTaps: 0, lifeCoins: 5000,
    cards: {}, // {id: level}
    party: {}, // {id: {lvl, xp}}
    energy: CONSTANTS.ENERGY.MAX, lastEup: Date.now(),
    combo: 0, lastTap: 0, streak: 1, lastLog: todayStr(),
    daily: { taps: 0, earned: 0, claimed: false },
    missions: {}, // {id: progress}
    completedIds: [], watched: [], boosts: [], managers: [],
    ver: APP_VERSION, user: null, lastSave: Date.now()
});

const loadState = () => {
    try {
        const raw = localStorage.getItem('dss_gamestate');
        gameState = raw ? { ...defaultState(), ...JSON.parse(raw) } : defaultState();
    } catch { gameState = defaultState(); }

    // Process Offline & Daily Reset
    const now = Date.now();
    const pph = calcPPH();
    const hrs = (now - gameState.lastSave) / 36e5;
    if (hrs > 0.1 && pph > 0) {
        const earn = Math.min(hrs, 12) * pph; // Max 12h offline
        gameState.coins += earn; gameState.lifeCoins += earn;
        setTimeout(() => notify(`Offline income: +${fmt(earn)}💰`, 'success'), 1000);
    }

    if (gameState.lastLog !== todayStr()) {
        gameState.streak = (new Date(gameState.lastLog).getTime() > now - 1.8e8) ? Math.min(gameState.streak + 1, STREAK_BONUS.length) : 1;
        gameState.lastLog = todayStr();
        gameState.daily = { taps: 0, earned: 0, claimed: false };
        gameState.missions = {};
    }
};

const saveState = () => {
    if (!gameState) return;
    gameState.lastSave = Date.now();
    gameState.tci = calcTCI(); // Pre-calc for leaderboard
    localStorage.setItem('dss_gamestate', JSON.stringify(gameState));
};

// --- CALCULATIONS ---
const calcTap = () => {
    let base = 1 + Object.entries(gameState.cards).reduce((acc, [id, lvl]) => {
        const c = GAME_CONFIG.candidates.find(x => x.id == id);
        return acc + (c?.active ? (c.baseBonus * lvl) : 0);
    }, 0);
    
    const boost = gameState.boosts.reduce((acc, b) => acc * b.mult, 1);
    const streak = 1 + (STREAK_BONUS[gameState.streak-1] || 0) / 100;
    return Math.floor(base * boost * streak);
};

const calcPPH = () => {
    let base = Object.entries(gameState.cards).reduce((acc, [id, lvl]) => {
        const c = GAME_CONFIG.candidates.find(x => x.id == id);
        return acc + (c?.active ? (c.profitPerHour * lvl) : 0);
    }, 0);
    const mMult = gameState.managers.reduce((acc, mid) => acc * (GAME_CONFIG.managers.find(m=>m.id==mid)?.effect || 1), 1);
    return Math.floor(base * mMult);
};

const calcTCI = () => {
    const c = gameState.lifeCoins / CONSTANTS.TCI_SCALE.COINS;
    const l = Object.values(gameState.cards).reduce((a,b)=>a+b,0) * CONSTANTS.TCI_SCALE.CARD_LVL;
    return Math.floor(c + l);
};

// --- GAME LOOP ---
const loop = () => {
    const now = Date.now();
    // Energy
    const dt = (now - gameState.lastEup) / 1000;
    gameState.energy = Math.min(CONSTANTS.ENERGY.MAX, gameState.energy + dt * CONSTANTS.ENERGY.REGEN);
    gameState.lastEup = now;

    // Boosts
    gameState.boosts = gameState.boosts.filter(b => b.end > now);
    
    requestAnimationFrame(renderUIFast);
};

// --- ACTIONS ---
const handleTap = (e) => {
    if (gameState.energy < 1) return;
    const now = Date.now();
    const isTouch = e.type === 'touchstart';
    if(isTouch) e.preventDefault();

    gameState.energy--;
    gameState.combo = (now - gameState.lastTap < CONSTANTS.TIMERS.COMBO) ? gameState.combo + 1 : 1;
    gameState.lastTap = now;

    const power = calcTap();
    const gain = power * (1 + Math.min(gameState.combo, 50) * 0.02); // Slight combo bonus
    const finalGain = Math.floor(gain);

    gameState.coins += finalGain;
    gameState.lifeCoins += finalGain;
    gameState.totalTaps++;
    gameState.daily.taps++;
    gameState.daily.earned += finalGain;

    // UX
    spawnFeedback(e, finalGain);
    const btn = $('tapButton');
    btn.style.transform = 'scale(0.95)';
    setTimeout(() => btn.style.transform = 'scale(1)', 50);

    checkProgression();
};

const spawnFeedback = (e, amt) => {
    const p = e.touches?.[0] || e;
    const el = document.createElement('div');
    el.className = 'tap-feedback font-black';
    el.innerHTML = `+${amt}`;
    el.style.left = `${p.clientX + (Math.random()*20-10)}px`;
    el.style.top = `${p.clientY}px`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 800);
};

const checkProgression = () => {
    // Daily Goal
    if (gameState.daily.taps >= CONSTANTS.DAILY.TAPS && !gameState.daily.claimed) {
        gameState.coins += CONSTANTS.DAILY.COINS;
        gameState.tokens += CONSTANTS.DAILY.TOKENS;
        gameState.daily.claimed = true;
        notify("Daily Goal Reached! Reward Claimed.", 'success');
        renderHeader(); // Full re-render needed for tokens
    }

    // Missions
    let updated = false;
    DAILY_MISSIONS.forEach(m => {
        if (gameState.completedIds.includes(m.id)) return;
        let curr = m.type === 'taps' ? gameState.daily.taps : gameState.daily.earned;
        gameState.missions[m.id] = curr;
        if (curr >= m.target) {
            gameState.coins += m.reward;
            gameState.completedIds.push(m.id);
            notify(`Mission: ${m.desc} Complete!`, 'success');
            updated = true;
        }
    });
    if (updated && activeTab === 'missions') renderTab();
};

const handleAction = (e) => {
    const tgt = e.target.closest('[data-act]');
    if (!tgt) return;
    const { act, id, type } = tgt.dataset;
    let needsRender = false;

    switch(act) {
        case 'buyC': // Buy Candidate
            const c = GAME_CONFIG.candidates.find(x => x.id == id);
            if (c && c.active && gameState.coins >= c.bid && !gameState.cards[id]) {
                gameState.coins -= c.bid;
                gameState.cards[id] = 1;
                notify(`Joined ${c.name}'s campaign!`, 'success');
                needsRender = true;
            }
            break;
        case 'upgC': // Upgrade Candidate
            const lvl = gameState.cards[id];
            const cand = GAME_CONFIG.candidates.find(x => x.id == id);
            if (lvl && cand && cand.active) {
                const cost = Math.floor(cand.bid * Math.pow(1.6, lvl));
                if (gameState.coins >= cost) {
                    gameState.coins -= cost;
                    gameState.cards[id]++;
                    notify(`Upgraded to Lv. ${lvl+1}!`, 'success');
                    needsRender = true;
                }
            }
            break;
        case 'watch':
            const vidId = type+id;
            if(!gameState.watched.includes(vidId)) {
                const item = type === 'c' ? GAME_CONFIG.candidates.find(x=>x.id==id) : GAME_CONFIG.parties[id];
                if(item) {
                    gameState.coins += (item.videoReward || 1000);
                    gameState.watched.push(vidId);
                    notify("Thanks for watching! Reward added.", 'success');
                    needsRender = true;
                }
            }
            break;
        // --- ADMIN ACTIONS ---
        case 'admToggle':
            const isParty = type === 'p';
            const obj = isParty ? GAME_CONFIG.parties[id] : GAME_CONFIG.candidates.find(x=>x.id==id);
            if(obj) {
                obj.active = !obj.active;
                saveAdminOverrides();
                renderAdmin(); // Re-render admin panel immediately
                needsRender = true; // Re-render main UI
            }
            break;
        case 'admSpon':
            const cs = GAME_CONFIG.candidates.find(x=>x.id==id);
            if(cs) {
                cs.sponsored = !cs.sponsored;
                saveAdminOverrides();
                renderAdmin();
                needsRender = true;
            }
            break;
    }

    if(needsRender) { renderHeader(); renderTab(); saveState(); }
};

// --- RENDERING ---
const renderUIFast = () => {
    // Updates frequent elements directly
    $('ui-coins').innerText = fmt(gameState.coins);
    $('ui-energy').style.width = `${(gameState.energy/CONSTANTS.ENERGY.MAX)*100}%`;
    $('ui-energy-txt').innerText = Math.floor(gameState.energy);
    
    if (activeTab === 'tap') {
        $('ui-power').innerText = `+${calcTap()}`;
        const ch = $('ui-combo');
        if(gameState.combo > 1) {
            ch.innerText = `${gameState.combo}x`;
            ch.style.opacity = 1;
        } else { ch.style.opacity = 0; }
    }
    setTimeout(loop, CONSTANTS.TIMERS.TICK);
};

const renderHeader = () => {
    DOM.header.innerHTML = `
        <div class="flex justify-between items-center px-2">
            <div class="flex items-center gap-2 bg-slate-900/50 px-3 py-1.5 rounded-full border border-slate-600">
                <img src="${telegramUser?.photo_url || 'https://placehold.co/40'}" class="w-6 h-6 rounded-full">
                <span class="font-bold text-sm truncate max-w-[80px]">${telegramUser?.username || 'Player'}</span>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-400">Influence (TCI)</div>
                <div class="font-black text-green-400 text-lg leading-none">${fmt(calcTCI())}</div>
            </div>
        </div>
        <div class="mt-3 flex justify-center items-center gap-2">
            <img src="https://cdn-icons-png.flaticon.com/512/11079/11079191.png" class="w-10 h-10 filter drop-shadow-lg">
            <span id="ui-coins" class="text-3xl font-black text-white tracking-wide drop-shadow-md">0</span>
        </div>
        <div class="grid grid-cols-3 gap-2 mt-3 text-center text-xs font-bold bg-slate-900/60 rounded-lg p-2">
            <div><div class="text-blue-400">+${fmt(calcTap())}</div><div class="text-gray-500 font-normal">Tap</div></div>
            <div><div class="text-green-400">+${fmt(calcPPH())}</div><div class="text-gray-500 font-normal">/Hr</div></div>
            <div><div class="text-purple-400">${gameState.tokens}</div><div class="text-gray-500 font-normal">Tokens</div></div>
        </div>
    `;
};

const switchTab = (t) => {
    activeTab = t;
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hide'));
    DOM.tabs[t].classList.remove('hide');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.tab === t));
    renderTab();
};

const renderTab = () => {
    const t = DOM.tabs[activeTab];
    if (activeTab === 'tap') {
        const dPerc = Math.min(100, (gameState.daily.taps/CONSTANTS.DAILY.TAPS)*100);
        t.innerHTML = `
            <div class="flex justify-between items-center px-4 mt-2 mb-6">
                <div class="flex items-center gap-1 text-yellow-400 font-bold"><i class="fa fa-bolt"></i> <span id="ui-energy-txt">0</span></div>
                <div class="flexItems-center gap-1 text-orange-400 font-bold">🔥 Day ${gameState.streak}</div>
            </div>
            <div class="relative flex justify-center items-center mb-6">
                <div class="absolute inset-0 rounded-full bg-blue-500/20 blur-3xl transform scale-75"></div>
                <button id="tapButton" class="z-10 flex flex-col items-center justify-center text-white">
                    <span class="text-sm font-bold opacity-80">TAP</span>
                    <span id="ui-power" class="text-4xl font-black leading-none">0</span>
                </button>
                <div id="ui-combo" class="absolute top-0 right-10 font-black text-yellow-300 text-xl rotate-12 transition-opacity duration-300" style="opacity:0"></div>
            </div>
            <div class="px-4">
                <div class="h-3 bg-slate-700 rounded-full overflow-hidden border border-slate-600 relative">
                    <div id="ui-energy" class="h-full bg-gradient-to-r from-yellow-500 to-yellow-300 transition-all duration-300 absolute top-0 left-0"></div>
                </div>
                <div class="mt-4 bg-slate-800/80 rounded-xl p-3 border border-slate-700">
                    <div class="flex justify-between text-xs mb-1"><span>Daily Goal</span><span>${gameState.daily.claimed ? 'Claimed ✅' : `${gameState.daily.taps}/${CONSTANTS.DAILY.TAPS}`}</span></div>
                    <div class="h-2 bg-slate-700 rounded-full overflow-hidden"><div class="h-full bg-blue-500" style="width:${dPerc}%"></div></div>
                </div>
            </div>
        `;
        $('tapButton').addEventListener('touchstart', handleTap, {passive:false});
        $('tapButton').addEventListener('mousedown', handleTap);
    }
    else if (activeTab === 'cards') {
        const sorted = [...GAME_CONFIG.candidates].sort((a,b) => (b.sponsored?1:0) - (a.sponsored?1:0) || (b.active?1:0) - (a.active?1:0));
        t.innerHTML = `<div class="px-3 pb-4 space-y-3 pt-2">
            ${sorted.map(c => {
                const owned = gameState.cards[c.id];
                const lvl = owned || 0;
                const pph = c.profitPerHour * (lvl || 1);
                const cost = Math.floor(c.bid * Math.pow(1.6, lvl));
                const canAfford = gameState.coins >= cost;
                
                // BUSINESS LOGIC: Visually lock inactive cards
                const uiState = !c.active ? 'opacity-50 filter-grayscale pointer-events-none' : owned ? 'bg-slate-800 border-blue-500/50' : 'bg-slate-800/50 border-slate-700';
                
                return `
                <div class="relative rounded-xl p-3 border ${uiState} flex gap-3 items-center transition-all">
                    ${c.sponsored && c.active ? '<div class="absolute top-0 right-0 bg-yellow-500 text-black text-[10px] font-bold px-2 py-0.5 rounded-bl-lg rounded-tr-xl z-10">⭐ SPONSORED</div>' : ''}
                    <img src="${c.photo}" class="w-16 h-16 rounded-lg object-cover border-2 ${c.logoColor}">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-end">
                            <h3 class="font-bold truncate leading-tight">${c.name}</h3>
                            ${owned ? `<span class="text-xs font-bold text-blue-400">Lvl ${lvl}</span>` : ''}
                        </div>
                        <p class="text-xs text-gray-400 truncate">${GAME_CONFIG.parties[c.party]?.name}</p>
                        <div class="text-[10px] text-gray-500 mt-1">Profit: <span class="text-green-400 font-bold">+${fmt(pph)}/h</span></div>
                    </div>
                    <div class="w-24 shrink-0">
                        ${!c.active ? 
                            `<button class="w-full py-2 bg-slate-700 text-gray-400 font-bold text-xs rounded flex items-center justify-center gap-1"><i class="fa fa-lock"></i> Locked</button>` :
                          owned ? 
                            `<button data-act="upgC" data-id="${c.id}" class="w-full py-1 bg-blue-600 rounded text-xs font-bold disabled:opacity-50 disabled:bg-slate-600" ${!canAfford?'disabled':''}>
                                <div>Upg</div><div class="font-normal">💰${fmt(cost)}</div>
                             </button>` : 
                            `<button data-act="buyC" data-id="${c.id}" class="w-full py-2 bg-green-600 rounded text-xs font-bold disabled:opacity-50" ${!canAfford?'disabled':''}>
                                Hire 💰${fmt(c.bid)}
                             </button>`
                        }
                    </div>
                </div>`
            }).join('')}
            <div class="h-10"></div> <!-- Spacer -->
        </div>`;
    }
    else if (activeTab === 'media') {
        // BUSINESS LOGIC: Only show media for ACTIVE candidates/parties
        const vids = [
            ...GAME_CONFIG.candidates.filter(c => c.active && c.promoVideo).map(c => ({id: c.id, type:'c', name: c.name, img: c.photo, rw: c.videoReward})),
            ...Object.entries(GAME_CONFIG.parties).filter(([k,v]) => v.active && v.promoVideo).map(([k,v]) => ({id: k, type:'p', name: v.name, img: v.logo, rw: v.videoReward}))
        ];
        
        t.innerHTML = `<div class="px-3 pt-2 grid grid-cols-2 gap-3">
            ${vids.length === 0 ? '<p class="col-span-2 text-center text-gray-500 mt-10">No sponsored media available right now.</p>' : ''}
            ${vids.map(v => {
                const isWatched = gameState.watched.includes(v.type+v.id);
                return `
                <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 flex flex-col">
                    <div class="relative h-24 bg-slate-900 flex items-center justify-center text-4xl">
                        ${v.type==='c' ? `<img src="${v.img}" class="w-full h-full object-cover opacity-50">` : v.img}
                        <i class="fa fa-play-circle absolute text-white/80 text-3xl drop-shadow-lg"></i>
                    </div>
                    <div class="p-2 flex-1 flex flex-col justify-between">
                        <div class="font-bold text-sm truncate text-center mb-2">${v.name}</div>
                        <button data-act="watch" data-type="${v.type}" data-id="${v.id}" class="w-full py-1.5 rounded text-xs font-bold ${isWatched ? 'bg-slate-600 text-gray-400' : 'bg-red-600 text-white'}" ${isWatched?'disabled':''}>
                            ${isWatched ? 'Watched' : `Watch +${fmt(v.rw||1000)}💰`}
                        </button>
                    </div>
                </div>`
            }).join('')}
        </div>`;
    }
    // ... (Implementation for Party, Missions, Store, Leaderboard would follow similar optimized patterns)
    else {
        t.innerHTML = `<div class="flex h-full items-center justify-center text-gray-500">Comming Soon</div>`;
    }
};

// --- ADMIN PANEL ---
const renderAdmin = () => {
    const html = `
    <div class="p-1">
        <div class="bg-slate-900 p-3 rounded-lg mb-4 text-sm">
            <h3 class="text-blue-400 font-bold mb-1">💼 Business Panel</h3>
            <p class="text-gray-400">Contact: <span class="text-white select-all">${ADMIN_INFO.contact}</span></p>
            <div class="grid grid-cols-2 gap-2 mt-2 text-xs">
                <div class="bg-slate-800 p-1 rounded">Cand: ${ADMIN_INFO.rates.candidate}</div>
                <div class="bg-slate-800 p-1 rounded">Party: ${ADMIN_INFO.rates.party}</div>
            </div>
        </div>

        <h4 class="font-bold text-white mb-2 sticky top-0 bg-slate-800 py-2">Candidates (${GAME_CONFIG.candidates.length})</h4>
        <div class="space-y-2 mb-6">
            ${GAME_CONFIG.candidates.map(c => `
            <div class="flex items-center justify-between bg-slate-900 p-2 rounded border ${c.active?'border-green-900':'border-slate-700'}">
                <div class="flex items-center gap-2">
                    <img src="${c.photo}" class="w-8 h-8 rounded bg-slate-700 object-cover">
                    <div class="text-sm">
                        <div class="font-bold ${c.active?'text-white':'text-gray-500'}">${c.name}</div>
                        <div class="text-[10px] text-gray-400">${c.sponsored ? '⭐ Sponsor' : 'Standard'}</div>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button data-act="admSpon" data-id="${c.id}" class="px-2 py-1 rounded text-[10px] font-bold ${c.sponsored?'bg-yellow-600 text-black':'bg-slate-700 text-gray-400'}"><i class="fa fa-star"></i></button>
                    <button data-act="admToggle" data-type="c" data-id="${c.id}" class="w-16 py-1 rounded text-[10px] font-bold ${c.active?'bg-red-900 text-red-200':'bg-green-600 text-white'}">
                        ${c.active ? 'DEACTIVATE' : 'ACTIVATE'}
                    </button>
                </div>
            </div>`).join('')}
        </div>

        <h4 class="font-bold text-white mb-2 sticky top-0 bg-slate-800 py-2">Parties</h4>
        <div class="space-y-2">
            ${Object.entries(GAME_CONFIG.parties).map(([id, p]) => `
            <div class="flex items-center justify-between bg-slate-900 p-2 rounded border ${p.active?'border-green-900':'border-slate-700'}">
                <div class="flex items-center gap-2">
                    <div class="text-xl w-8 text-center">${p.logo}</div>
                    <div class="text-sm font-bold ${p.active?'text-white':'text-gray-500'}">${p.name}</div>
                </div>
                <button data-act="admToggle" data-type="p" data-id="${id}" class="w-16 py-1 rounded text-[10px] font-bold ${p.active?'bg-red-900 text-red-200':'bg-green-600 text-white'}">
                    ${p.active ? 'DEACTIVATE' : 'ACTIVATE'}
                </button>
            </div>`).join('')}
        </div>
        
        <div class="mt-6 pt-4 border-t border-slate-700">
            <button onclick="if(confirm('Clear all local data?')) {localStorage.clear();location.reload();}" class="w-full bg-red-900/50 border border-red-800 text-red-400 text-xs py-2 rounded">⚠️ Hard Reset App</button>
        </div>
    </div>`;
    
    DOM.modals.innerHTML = `<div class="modal-overlay" onclick="this.parentElement.innerHTML=''"></div>
    <div class="modal bg-slate-800 w-[95%] max-w-md rounded-xl border border-slate-600 flex flex-col max-h-[85vh]">
        <div class="flex justify-between items-center p-3 border-b border-slate-700">
            <h2 class="font-bold text-lg">Admin Control</h2>
            <button onclick="DOM.modals.innerHTML=''" class="w-8 h-8 bg-slate-700 rounded-full"><i class="fa fa-times"></i></button>
        </div>
        <div class="overflow-y-auto p-3 flex-1">${html}</div>
    </div>`;
};

// --- INIT ---
const init = async () => {
    // 1. Telegram Init
    if (window.Telegram?.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();
        tg.setHeaderColor('#1e293b');
        telegramUser = tg.initDataUnsafe?.user;
        // SECURITY CHECK: Only show admin button for specfic ID
        if(telegramUser?.id === YOUR_ADMIN_TELEGRAM_ID) {
            DOM.adminBtn.style.display = 'flex';
        }
    } else {
        // Dev mode fallback
        telegramUser = {id: 999, username: 'Dev', first_name: 'Dev'};
        if(YOUR_ADMIN_TELEGRAM_ID === 999) DOM.adminBtn.style.display = 'flex';
    }

    // 2. Render Nav
    DOM.nav.innerHTML = ['tap', 'cards', 'missions', 'media', 'leaderboard']
        .map(t => `<button class="nav-item flex-1 py-1 text-gray-500 transition-colors rounded-lg ${t===activeTab?'active':''}" data-tab="${t}" onclick="switchTab('${t}')">
            <i class="fa fa-${{tap:'hand-pointer',cards:'users',missions:'tasks',media:'play-circle',party:'flag',store:'shopping-cart',leaderboard:'trophy'}[t]} text-xl"></i>
            <div class="text-[10px] font-bold mt-0.5 capitalize">${t}</div>
        </button>`).join('');

    // 3. Load Data
    await loadConfig();
    loadState();

    // 4. Start
    DOM.loader.classList.add('opacity-0', 'pointer-events-none');
    renderHeader();
    renderTab();
    loop();
    renderUIFast(); // Kickstart UI loop

    // Listeners
    document.body.addEventListener('click', handleAction);
    DOM.adminBtn.onclick = renderAdmin;
    setInterval(saveState, CONSTANTS.TIMERS.SAVE);
};

init();
});
</script>
</body>
</html>
