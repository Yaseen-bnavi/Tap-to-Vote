<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Supreme Strategic Campaign Simulator (Iraq)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- === FIREBASE SDKs (NEW) === -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- ============================= -->

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 70%, #0f172a 100%);
            overscroll-behavior-y: contain;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .tap-feedback {
            position: absolute;
            font-size: 2.2rem;
            font-weight: 900;
            color: #fcd34d;
            text-shadow: 0 2px 8px #000;
            pointer-events: none;
            animation: floatup 0.9s ease-out forwards;
            white-space: nowrap;
            z-index: 100;
        }
        @keyframes floatup {
            0% { transform: translateY(0) scale(1.2); opacity: 1; }
            100% { transform: translateY(-80px) scale(0.8); opacity: 0; }
        }
        #tapButton {
            width: 230px;
            height: 230px;
            background: radial-gradient(circle at center, #3b82f6 0%, #1e40af 70%, #1e3a8a 100%);
            border: 6px solid #fef3c7;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.9);
            box-shadow: 0 15px 40px rgba(37, 99, 235, 0.7), 0 0 0 15px rgba(254, 243, 199, 0.2);
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            touch-action: manipulation;
        }
        #tapButton.boost-active {
             animation: boostPulse 1s infinite;
        }
        @keyframes boostPulse {
            0% { box-shadow: 0 15px 40px rgba(37, 99, 235, 0.7), 0 0 0 15px rgba(254, 243, 199, 0.2); }
            50% { box-shadow: 0 20px 60px rgba(59, 130, 246, 0.9), 0 0 0 20px rgba(254, 243, 199, 0.5); }
            100% { box-shadow: 0 15px 40px rgba(37, 99, 235, 0.7), 0 0 0 15px rgba(254, 243, 199, 0.2); }
        }
        #tapButton:active { transform: scale(0.95); }
        .nav-item.active { color: #3b82f6; background-color: #1e293b; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1001; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 1000; }
        .filter-grayscale { filter: grayscale(1); opacity: 0.7; }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1e293b;
            border-left: 4px solid;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            max-width: 300px;
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification.success { border-left-color: #10b981; }
        .notification.error { border-left-color: #ef4444; }
        .notification.info { border-left-color: #3b82f6; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .video-thumbnail {
            position: relative;
            aspect-ratio: 16/9;
            border-radius: 8px;
            overflow: hidden;
            background: #1e293b;
            cursor: pointer;
        }
        .video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-thumbnail .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }
        .invite-section {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .invite-code {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            font-family: monospace;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
            letter-spacing: 1px;
        }
        .sync-status {
            position: fixed;
            top: 60px;
            right: 20px;
            background: #1e293b;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 12px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sync-status.syncing { background: #3b82f6; }
        .sync-status.success { background: #10b981; }
        .sync-status.error { background: #ef4444; }
    </style>
</head>
<body class="text-slate-100 p-4 pb-24 max-w-lg mx-auto min-h-screen">

    <div id="loadingIndicator" class="fixed inset-0 bg-gray-900/90 z-[2000] flex justify-center items-center">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-yellow-500 mb-4"></div>
            <p class="text-white text-xl">Loading Campaign Data...</p>
        </div>
    </div>

    <div id="syncStatus" class="sync-status hidden">
        <i class="fa fa-sync-alt"></i>
        <span>Syncing...</span>
    </div>

    <button id="settingsToggle" class="fixed top-4 right-4 z-50 bg-slate-700/80 hover:bg-slate-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg backdrop-blur-sm">
        <i class="fa fa-cog"></i>
    </button>

    <header id="header" class="w-full mb-4 p-4 bg-slate-800/80 rounded-xl shadow-2xl border border-slate-700/50 sticky top-4 z-30"></header>

    <main class="w-full flex-grow">
        <div id="tap" class="tab-content flex flex-col items-center"></div>
        <div id="cards" class="tab-content hidden"></div>
        <div id="missions" class="tab-content hidden"></div>
        <div id="media" class="tab-content hidden"></div>
        <div id="party" class="tab-content hidden"></div>
        <div id="store" class="tab-content hidden"></div>
        <div id="leaderboard" class="tab-content hidden"></div>
        <div id="invite" class="tab-content hidden"></div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto w-full flex justify-around p-2 border-t border-gray-700/50 rounded-t-xl z-40 bg-[#0f172a]"></nav>
    
    <div id="modalContainer"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

// ==========================================
// 🔥 FIREBASE SETUP (NEW)
// ==========================================
// PASTE THE firebaseConfig OBJECT YOU COPIED FROM THE FIREBASE CONSOLE HERE
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyB2_crTy9dmsS7SpR-8r5fBY-xHuuUAPZM",
    authDomain: "campaign-simulator-game.firebaseapp.com",
    projectId: "campaign-simulator-game",
    storageBucket: "campaign-simulator-game.firebasestorage.app",
    messagingSenderId: "1031367881969",
    appId: "1:1031367881969:web:ef37beeab2904143926550"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>

// INITIALIZE FIREBASE
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ==========================================
// 🎯 GAME CONFIGURATION
// ==========================================
const GITHUB_ASSETS_BASE_URL = 'https://raw.githubusercontent.com/Yaseen-bnavi/Tap-to-Vote/main/';
const CONFIG_URLS = {
    parties: `${GITHUB_ASSETS_BASE_URL}config/parties.json`,
    candidates: `${GITHUB_ASSETS_BASE_URL}config/candidates.json`,
    managers: `${GITHUB_ASSETS_BASE_URL}config/managers.json`
};

// ==========================================
// 🎮 GAME CONSTANTS
// ==========================================
const TCI_SCALING = { COINS: 50000, CARD_LEVEL: 25, PARTY_LEVEL: 100 };
const ENERGY_MAX = 80;
const ENERGY_REGEN_RATE = 0.8;
const COMBO_TIMEOUT = 1500;
const STREAK_BONUS = [0, 2, 5, 8, 12, 17, 23, 30, 38, 50];
const DAILY_GOAL = 150;
const DAILY_REWARD_COINS = 2000;
const DAILY_REWARD_TOKENS = 1;
const INVITE_REWARD = { coins: 5000, tokens: 1 };
const REFERRAL_BONUS = { coins: 1000, tokens: 0.5 };

const getInflationMultiplier = (totalLifetimeCoins) => {
    const milestones = [10000, 50000, 200000, 1000000, 5000000];
    let multiplier = 1;
    milestones.forEach(milestone => {
        if (totalLifetimeCoins > milestone) multiplier += 0.5;
    });
    return Math.min(multiplier, 4);
};

const ACHIEVEMENTS = [
    { id: 'taps1', type: 'taps', threshold: 500, title: "First Steps", description: "Reach 500 total taps", reward: 1000 },
    { id: 'taps2', type: 'taps', threshold: 2500, title: "Getting Serious", description: "Reach 2,500 total taps", reward: 5000 },
    { id: 'coins1', type: 'coins', threshold: 50000, title: "Wealthy Backer", description: "Accumulate 50,000 coins", reward: 10000 },
    { id: 'cards1', type: 'cards', threshold: 3, title: "Building a Team", description: "Own 3 candidate cards", reward: 5000 },
    { id: 'invite1', type: 'invites', threshold: 3, title: "Social Influencer", description: "Invite 3 friends", reward: 5000 },
];

const DAILY_MISSIONS = [
    { id: 1, type: 'taps', target: 100, reward: 500, title: "Tap 100 Times", description: "Basic tapping mission" },
    { id: 3, type: 'coins', target: 25000, reward: 1000, title: "Earn 25,000 Funds", description: "Wealth accumulation" },
];

const BOOSTS = [
    { id: 'boost_2x', name: "2x Multiplier", duration: 30, cost: 10000, multiplier: 2, icon: '⚡' },
    { id: 'boost_energy', name: "Energy Refill", duration: 0, cost: 5000, energy: 40, icon: '🔋' },
];

// ==========================================
// 🎲 GAME STATE
// ==========================================
let GAME_CONFIG = { parties: {}, candidates: [], managers: [] };
let gameState;
let activeTab = 'tap';
let telegramUser = null;
let lastSyncTime = 0;
const SYNC_COOLDOWN = 30000; // 30 seconds

// ==========================================
// 🛠️ UTILITY FUNCTIONS
// ==========================================
const formatNumber = (num) => {
    if (isNaN(num) || num === null) return '0';
    if (num >= 1_000_000) return `${(num / 1_000_000).toFixed(1)}M`;
    if (num >= 1_000) return `${(num / 1_000).toFixed(1)}K`;
    return Math.floor(num).toString();
};

const getTodayString = () => new Date().toISOString().split('T')[0];

const showNotification = (text, type = 'info', duration = 3000) => {
    const existing = document.querySelector('.notification');
    if (existing) existing.remove();
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `<p>${text}</p>`;
    document.body.appendChild(notification);
    setTimeout(() => { if (notification.parentElement) notification.remove(); }, duration);
};

const showSyncStatus = (status, message = '') => {
    const syncStatus = document.getElementById('syncStatus');
    syncStatus.className = 'sync-status ' + status;
    syncStatus.querySelector('span').textContent = message;
    syncStatus.classList.remove('hidden');
    if (status === 'success' || status === 'error') {
        setTimeout(() => syncStatus.classList.add('hidden'), 3000);
    }
};

const getYouTubeThumbnail = (url) => {
    try {
        const videoId = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
        return videoId && videoId[1] ? `https://img.youtube.com/vi/${videoId[1]}/mqdefault.jpg` : 'https://via.placeholder.com/320x180';
    } catch {
        return 'https://via.placeholder.com/320x180';
    }
};

// ==========================================
// ☁️ FIREBASE INTEGRATION (REPLACES GOOGLE SHEETS)
// ==========================================
const syncWithFirebase = async (force = false) => {
    const now = Date.now();
    if (!force && now - lastSyncTime < SYNC_COOLDOWN) return;
    lastSyncTime = now;

    if (!gameState || !gameState.userId) {
        console.error("Cannot sync, game state or user ID is missing.");
        return false;
    }

    try {
        showSyncStatus('syncing', 'Syncing...');
        const userData = {
            userId: gameState.userId,
            telegramId: telegramUser?.id || gameState.telegramId || null,
            username: telegramUser?.username || gameState.telegramUsername || 'anonymous',
            score: gameState.totalCampaignInfluence,
            // Add any other fields you want to save
            ...gameState 
        };
        
        // Use set with merge:true to create or update the document without overwriting everything
        await db.collection("users").doc(userData.userId).set(userData, { merge: true });
        
        showSyncStatus('success', 'Synced!');
        console.log('✅ Data synced to Firebase');
        return true;
    } catch (error) {
        console.error('❌ Failed to sync with Firebase:', error);
        showSyncStatus('error', 'Sync failed');
        return false;
    }
};

// ==========================================
// 📁 CONFIGURATION LOADING
// ==========================================
const loadExternalConfig = async () => {
    try {
        console.log('Loading external configuration...');
        const responses = await Promise.all([
            fetch(CONFIG_URLS.parties),
            fetch(CONFIG_URLS.candidates),
            fetch(CONFIG_URLS.managers)
        ]);
        if (responses.some(res => !res.ok)) throw new Error('Failed to load one or more config files.');
        
        GAME_CONFIG.parties = await responses[0].json();
        GAME_CONFIG.candidates = await responses[1].json();
        GAME_CONFIG.managers = await responses[2].json();
        
        console.log('✅ All external config loaded successfully!');
    } catch (error) {
        console.error('❌ Error loading external config:', error);
        showNotification('Failed to load game data. Using defaults.', 'error');
        // Simple fallback
        GAME_CONFIG = { parties: {}, candidates: [], managers: [] };
    }
};

// ==========================================
// 🎯 CORE GAME LOGIC
// ==========================================
const calculatePPH = (state) => {
    if (!state || !state.userCards) return 0;
    const inflation = getInflationMultiplier(state.totalLifetimeCoins);
    let totalPPH = state.userCards.reduce((acc, card) => {
        const candidate = GAME_CONFIG.candidates.find(c => c.id === card.id);
        if (!candidate) return acc;
        let profit = (candidate.profitPerHour * card.level) / inflation;
        state.managerCards.forEach(managerId => {
            const manager = GAME_CONFIG.managers.find(m => m.id === managerId);
            if (manager) profit *= (1 + (manager.effect - 1) * 0.7);
        });
        return acc + profit;
    }, 0);
    return Math.floor(totalPPH);
};

const calculateTCI = (state) => {
    if (!state) return 0;
    const coinsTCI = Math.pow(state.totalLifetimeCoins || 0, 0.7) / TCI_SCALING.COINS;
    const cardsTCI = Math.pow(state.userCards?.reduce((acc, card) => acc + (card.level || 1), 0) || 0, 1.2) * TCI_SCALING.CARD_LEVEL;
    const partiesTCI = Math.pow(Object.values(state.parties || {})?.reduce((acc, party) => acc + (party.level || 1), 0) || 0, 1.1) * TCI_SCALING.PARTY_LEVEL;
    return Math.floor(coinsTCI + cardsTCI + partiesTCI);
};

const calculateTapPower = (state) => {
    if (!state) return 1;
    const inflation = getInflationMultiplier(state.totalLifetimeCoins);
    let basePower = 1 + (state.userCards?.reduce((acc, card) => {
        const c = GAME_CONFIG.candidates.find(c => c.id === card.id);
        return acc + (c ? c.baseBonus * Math.sqrt(card.level || 1) : 0);
    }, 0) || 0);
    let partyMultiplier = 1 + (Object.values(state.parties || {})?.reduce((acc, p) => acc + (p.level > 1 ? ((GAME_CONFIG.parties[p.id]?.multiplier || 1.03) - 1) * Math.log(p.level + 1) : 0), 0) || 0);
    const boostMultiplier = state.activeBoosts?.reduce((acc, b) => acc * (b.multiplier || 1), 1) || 1;
    const streakBonus = 1 + (STREAK_BONUS[state.streak || 0] / 100);
    return Math.floor((basePower * partyMultiplier * boostMultiplier * streakBonus) / Math.sqrt(inflation));
};

const saveGameState = () => {
    if (!gameState) return;
    try {
        gameState.lastPlayTime = Date.now();
        localStorage.setItem('campaignSimulatorSave', JSON.stringify(gameState));
        syncWithFirebase(); // Replaces old leaderboard logic
    } catch (e) {
        console.warn("Could not save game state.", e);
    }
};

const createDefaultGameState = () => ({
    coins: 500,
    influenceTokens: 0,
    dailyTaps: 0,
    totalTaps: 0,
    totalLifetimeCoins: 500,
    userCards: [],
    parties: Object.keys(GAME_CONFIG.parties || {}).reduce((acc, partyId) => {
        acc[partyId] = { level: 1, xp: 0, multiplier: 1.03, totalInvestment: 0 };
        return acc;
    }, {}),
    lastDailyRewardDate: null,
    userId: 'user_' + Date.now() + Math.random().toString(36).substr(2, 9),
    watchedVideos: {},
    managerCards: [],
    lastPlayTime: Date.now(),
    achievements: [],
    energy: ENERGY_MAX,
    lastEnergyUpdate: Date.now(),
    combo: 0,
    lastTapTime: 0,
    streak: 0,
    lastLoginDate: null,
    activeBoosts: [],
    completedMissions: [],
    missionProgress: DAILY_MISSIONS.reduce((acc, m) => ({ ...acc, [m.id]: { progress: 0 } }), {}),
    telegramUsername: 'user_' + Math.random().toString(36).substr(2, 6),
    telegramId: null,
    appVersion: '2.5.1-firebase',
    referrals: 0,
    referralCode: 'REF' + Math.random().toString(36).substr(2, 5).toUpperCase(),
    referredBy: null
});

const loadGameState = () => {
    let savedStateJSON = null;
    try {
        savedStateJSON = localStorage.getItem('campaignSimulatorSave');
    } catch (e) { console.warn("Could not access localStorage.", e); }

    const defaultState = createDefaultGameState();
    let initialState = savedStateJSON ? { ...defaultState, ...JSON.parse(savedStateJSON) } : defaultState;

    const urlParams = new URLSearchParams(window.location.search);
    const referralCode = urlParams.get('ref');
    if (referralCode && !initialState.referredBy) {
        initialState.referredBy = referralCode;
        showNotification("Joined via referral! Bonus rewards await.", 'success');
    }

    const now = Date.now();
    const timeOfflineHours = (now - initialState.lastPlayTime) / 3600000;
    const pph = calculatePPH(initialState);
    const offlineEarnings = Math.min(Math.floor(pph * timeOfflineHours), pph * 8);
    if (offlineEarnings > 0) {
        initialState.coins += offlineEarnings;
        initialState.totalLifetimeCoins += offlineEarnings;
        showNotification(`Welcome back! You earned ${formatNumber(offlineEarnings)}💰 offline.`, 'success');
    }

    const today = getTodayString();
    if (initialState.lastLoginDate !== today) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        initialState.streak = initialState.lastLoginDate === yesterday.toISOString().split('T')[0] ? Math.min(initialState.streak + 1, STREAK_BONUS.length - 1) : 1;
        initialState.lastLoginDate = today;
        initialState.dailyTaps = 0;
        initialState.completedMissions = [];
        initialState.missionProgress = DAILY_MISSIONS.reduce((acc, m) => ({ ...acc, [m.id]: { progress: 0 } }), {});
    }

    gameState = initialState;
};

const updateAll = () => {
    if (!gameState) return;
    gameState.tapPower = calculateTapPower(gameState);
    gameState.totalCampaignInfluence = calculateTCI(gameState);
    renderHeader();
    renderCurrentTab();
    saveGameState();
};

const checkAchievements = () => {
    ACHIEVEMENTS.forEach(ach => {
        if (gameState.achievements.includes(ach.id)) return;
        let conditionMet = false;
        if (ach.type === 'taps' && gameState.totalTaps >= ach.threshold) conditionMet = true;
        if (ach.type === 'coins' && gameState.totalLifetimeCoins >= ach.threshold) conditionMet = true;
        if (ach.type === 'cards' && gameState.userCards.length >= ach.threshold) conditionMet = true;
        if (ach.type === 'invites' && gameState.referrals >= ach.threshold) conditionMet = true;

        if (conditionMet) {
            gameState.achievements.push(ach.id);
            gameState.coins += ach.reward;
            gameState.totalLifetimeCoins += ach.reward;
            renderModal(`Achievement: ${ach.title}`, `<div class="text-center"><p>${ach.description}</p><p class="text-yellow-400 font-bold">Reward: +${formatNumber(ach.reward)}💰</p></div>`);
            saveGameState();
        }
    });
};

// ==========================================
// 🎮 EVENT HANDLERS
// ==========================================
const handleTap = (e) => {
    e.preventDefault();
    if (gameState.energy < 1) return;

    const now = Date.now();
    gameState.energy -= 1;
    let tapValue = calculateTapPower(gameState);
    if (Math.random() < 0.03) tapValue *= 2.5; // Critical hit

    const currentComboTimeout = gameState.activeBoosts.find(b => b.comboTime) ? COMBO_TIMEOUT + 1500 : COMBO_TIMEOUT;
    gameState.combo = (now - gameState.lastTapTime < currentComboTimeout) ? gameState.combo + 1 : 1;
    tapValue = Math.floor(tapValue * (1 + Math.min(gameState.combo * 0.03, 0.5)));

    const { clientX, clientY } = e.touches ? e.touches[0] : e;
    const feedback = document.createElement('div');
    feedback.className = 'tap-feedback';
    feedback.textContent = `+${formatNumber(tapValue)}`;
    feedback.style.left = `${clientX - 25}px`;
    feedback.style.top = `${clientY - 45}px`;
    document.body.appendChild(feedback);
    setTimeout(() => feedback.remove(), 900);

    gameState.coins += tapValue;
    gameState.totalTaps++;
    gameState.dailyTaps++;
    gameState.totalLifetimeCoins += tapValue;
    gameState.lastTapTime = now;

    if (gameState.dailyTaps === DAILY_GOAL && getTodayString() !== gameState.lastDailyRewardDate) {
        gameState.coins += DAILY_REWARD_COINS;
        gameState.influenceTokens += DAILY_REWARD_TOKENS;
        gameState.lastDailyRewardDate = getTodayString();
        showNotification(`Daily Goal! +${formatNumber(DAILY_REWARD_COINS)}💰 & +${DAILY_REWARD_TOKENS}💎`, 'success');
    }

    checkAchievements();
    updateAll();
};

// ==========================================
// 🎨 RENDER FUNCTIONS
// ==========================================
const navigate = (tabName) => {
    activeTab = tabName;
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.getElementById(tabName)?.classList.remove('hidden');
    renderNav();
    renderCurrentTab();
};

const renderCurrentTab = () => {
    const container = document.getElementById(activeTab);
    if (!container) return;
    const renderers = {
        tap: renderTapScreen,
        cards: renderCardsScreen,
        missions: renderMissionsScreen,
        media: renderMediaScreen,
        party: renderPartyScreen,
        store: renderStoreScreen,
        leaderboard: renderLeaderboardScreen, // This is async
        invite: renderInviteScreen,
    };
    if (activeTab === 'leaderboard') {
        container.innerHTML = `<div class="text-center p-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-yellow-500"></div></div>`;
        renderLeaderboardScreen();
    } else if (renderers[activeTab]) {
        container.innerHTML = renderers[activeTab]();
    }
    if (activeTab === 'tap') {
        const tapButton = document.getElementById('tapButton');
        if (tapButton) {
            const newButton = tapButton.cloneNode(true);
            tapButton.parentNode.replaceChild(newButton, tapButton);
            newButton.addEventListener('click', handleTap);
            newButton.addEventListener('touchstart', handleTap, { passive: false });
        }
    }
};

const renderHeader = () => {
    const energyPercentage = (gameState.energy / ENERGY_MAX) * 100;
    document.getElementById('header').innerHTML = `
        <div class="flex justify-around text-center">
            <div><p class="text-2xl font-extrabold text-yellow-400">${formatNumber(gameState.coins)}</p><p class="text-xs text-gray-400">Funds 💰</p></div>
            <div><p class="text-2xl font-extrabold text-green-400">${formatNumber(calculateTCI(gameState))}</p><p class="text-xs text-gray-400">Influence 📈</p></div>
        </div>
        <div class="mt-3">
            <div class="flex justify-between text-xs mb-1 px-1">
                <span class="text-yellow-400 font-bold">⚡ Energy</span>
                <span class="text-gray-300">${Math.floor(gameState.energy)}/${ENERGY_MAX}</span>
            </div>
            <div class="w-full h-2 bg-slate-700 rounded-full"><div class="h-full bg-yellow-400" style="width: ${energyPercentage}%"></div></div>
        </div>`;
};

const renderNav = () => {
    const navItems = [
        { tab: 'tap', icon: '👆', label: 'Tap' },
        { tab: 'cards', icon: '🎴', label: 'Cards' },
        { tab: 'missions', icon: '📋', label: 'Missions' },
        { tab: 'media', icon: '📺', label: 'Media' },
        { tab: 'party', icon: '🏛️', label: 'Party' },
        { tab: 'store', icon: '💎', label: 'Store' },
        { tab: 'leaderboard', icon: '🏆', label: 'Rank' },
        { tab: 'invite', icon: '👥', label: 'Invite' },
    ];
    document.querySelector('nav').innerHTML = navItems.map(({ tab, icon, label }) => `
        <button data-tab="${tab}" class="nav-item flex-1 flex flex-col items-center p-2 rounded-lg ${activeTab === tab ? 'active' : 'text-gray-400'}">
            <span class="text-2xl">${icon}</span><span class="text-xs mt-1">${label}</span>
        </button>`).join('');
};

const renderTapScreen = () => `
    <div class="relative mb-8 mt-4">
        <button id="tapButton" class="w-[230px] h-[230px] rounded-full flex flex-col justify-center items-center text-white font-black text-4xl">
            Tap! <span class="text-3xl mt-1">+${formatNumber(calculateTapPower(gameState))}</span>
        </button>
    </div>`;

const renderCardsScreen = () => `
    <h2 class="text-2xl font-bold text-center mb-4 text-yellow-400">Candidate Cards</h2>
    <div class="space-y-4">
        ${(GAME_CONFIG.candidates || []).map(c => `
            <div class="p-4 rounded-xl border-2 ${gameState.userCards.find(uc => uc.id === c.id) ? 'border-green-400' : 'border-slate-700'}">
                <h3 class="font-bold text-lg">${c.name}</h3>
                <p class="text-xs text-gray-400">${c.policy}</p>
                <button data-action="buyCard" data-id="${c.id}" class="w-full bg-purple-600 mt-2 py-2 rounded">Buy (${formatNumber(c.bid)})</button>
            </div>`).join('')}
    </div>`;

const renderMissionsScreen = () => `
    <h2 class="text-2xl font-bold text-center mb-4 text-yellow-400">Daily Missions</h2>
    <div class="space-y-3">
        ${DAILY_MISSIONS.map(m => `<div class="bg-slate-800 p-4 rounded-lg"><h4 class="font-bold">${m.title}</h4></div>`).join('')}
    </div>`;

const renderMediaScreen = () => `
    <h2 class="text-2xl font-bold text-center mb-4 text-yellow-400">Campaign Media</h2>
    <div class="space-y-4">
        ${(GAME_CONFIG.candidates || []).map(c => `
            <div class="bg-slate-800 p-4 rounded-xl">
                <h3 class="font-bold text-lg">${c.name}</h3>
                ${(c.promoVideos || []).map((video, index) => `<div class="video-thumbnail" data-action="watchVideo" data-type="candidate" data-id="${c.id}" data-index="${index}"><img src="${getYouTubeThumbnail(video.url)}"><div class="play-icon"><i class="fa fa-play"></i></div></div>`).join('')}
            </div>`).join('')}
    </div>`;

const renderPartyScreen = () => `
    <h2 class="text-2xl font-bold text-center mb-4 text-yellow-400">Political Parties</h2>
    <div class="space-y-4">
        ${Object.entries(GAME_CONFIG.parties || {}).map(([id, party]) => `
            <div class="p-4 rounded-xl border border-slate-700">
                <h3 class="font-bold text-lg">${party.name}</h3>
                <button data-action="investParty" data-id="${id}" class="w-full bg-blue-600 mt-2 py-2 rounded">Invest</button>
            </div>`).join('')}
    </div>`;

const renderStoreScreen = () => `
    <h2 class="text-2xl font-bold text-center mb-4 text-yellow-400">Store</h2>`;
    
const renderLeaderboardScreen = async () => {
    const container = document.getElementById('leaderboard');
    if (!container) return;
    try {
        const querySnapshot = await db.collection("users").orderBy("score", "desc").limit(20).get();
        const topPlayers = querySnapshot.docs.map(doc => doc.data());
        container.innerHTML = `
            <h2 class="text-2xl font-bold text-center mb-4 text-yellow-400">Leaderboard</h2>
            <div class="space-y-2">
                ${topPlayers.map((player, index) => `
                    <div class="flex items-center bg-slate-800 p-3 rounded-lg">
                        <div class="w-8 text-center">${index + 1}</div>
                        <div class="flex-1 font-bold">${player.username}</div>
                        <div class="font-bold text-yellow-400">${formatNumber(player.score)}</div>
                    </div>`).join('')}
            </div>`;
    } catch (error) {
        console.error("Error fetching leaderboard:", error);
        container.innerHTML = `<p class="text-center text-red-400">Could not load leaderboard.</p>`;
    }
};

const renderInviteScreen = () => {
    const referralUrl = `${window.location.origin}${window.location.pathname}?ref=${gameState.referralCode}`;
    return `
    <h2 class="text-2xl font-bold text-center mb-4">Invite Friends</h2>
    <div class="invite-section">
        <div class="invite-code">${gameState.referralCode}</div>
        <button data-action="copyReferralLink" class="w-full bg-blue-600 mt-2 py-2 rounded">Copy Link</button>
    </div>`;
};


const renderModal = (title, content, showClose = true) => {
    document.getElementById('modalContainer').innerHTML = `
        <div data-action="closeModal" class="modal-overlay"></div>
        <div class="modal bg-slate-800 w-[90%] p-6 rounded-xl">
            <h2 class="text-2xl font-bold text-center mb-4">${title}</h2>
            <div>${content}</div>
            ${showClose ? `<button data-action="closeModal" class="w-full mt-6 bg-blue-600 py-2 rounded">Close</button>` : ''}
        </div>`;
};

const closeModal = () => {
    document.getElementById('modalContainer').innerHTML = '';
};

// ==========================================
// ⚡ ACTION HANDLERS
// ==========================================
const handleAction = (e) => {
    const target = e.target.closest('[data-action]');
    if (!target) return;
    const { action, id, type, index } = target.dataset;

    const actions = {
        closeModal,
        buyCard: () => {
            const c = GAME_CONFIG.candidates.find(cand => cand.id == id);
            if (c && gameState.coins >= c.bid) {
                gameState.coins -= c.bid;
                gameState.userCards.push({ id: parseInt(id), level: 1 });
                updateAll();
            }
        },
        watchVideo: () => {
            const item = type === 'candidate' ? GAME_CONFIG.candidates.find(c => c.id == id) : GAME_CONFIG.parties[id];
            const video = (item.promoVideos || [])[parseInt(index || 0)];
            if (!video) return;
            let videoUrl = video.url.replace("watch?v=", "embed/");
            renderModal(video.title, `<iframe src="${videoUrl}" class="w-full h-64"></iframe>`, true);
        },
        investParty: () => {
            if (gameState.coins >= 2000) {
                gameState.coins -= 2000;
                const partyState = gameState.parties[id];
                if(partyState) partyState.xp += 150;
                updateAll();
            }
        },
        copyReferralLink: () => {
             const referralUrl = `${window.location.origin}${window.location.pathname}?ref=${gameState.referralCode}`;
             navigator.clipboard.writeText(referralUrl).then(() => showNotification("Link copied!", "success"));
        },
        forceSync: () => {
            syncWithFirebase(true).then(success => showNotification(success ? "Sync successful!" : "Sync failed.", success ? "success" : "error"));
        },
        resetGame: () => {
            if (confirm("Reset game? All progress will be lost!")) {
                localStorage.removeItem('campaignSimulatorSave');
                gameState = createDefaultGameState();
                updateAll();
            }
        }
    };
    if (actions[action]) actions[action]();
};

// ==========================================
// 🤖 TELEGRAM INTEGRATION
// ==========================================
const initTelegram = () => {
    if (window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.expand();
        telegramUser = tg.initDataUnsafe?.user || null;
        if (telegramUser) {
            gameState.telegramUsername = telegramUser.username || `user_${telegramUser.id}`;
            gameState.telegramId = telegramUser.id;
        }
    } else {
        console.log("Running outside Telegram, using test mode");
    }
};

// ==========================================
// 🚀 GAME INITIALIZATION
// ==========================================
const initGame = async () => {
    document.getElementById('loadingIndicator').style.display = 'flex';
    await loadExternalConfig();
    loadGameState();
    initTelegram();
    
    // Referral logic
    if (gameState.referredBy && !gameState.referralRewardClaimed) {
        gameState.coins += REFERRAL_BONUS.coins;
        gameState.totalLifetimeCoins += REFERRAL_BONUS.coins;
        gameState.referralRewardClaimed = true;
    }

    // Main game loop (1 second interval)
    setInterval(() => {
        if (!gameState) return;
        const now = Date.now();
        const timePassed = (now - gameState.lastEnergyUpdate) / 1000;
        gameState.energy = Math.min(ENERGY_MAX, gameState.energy + timePassed * ENERGY_REGEN_RATE);
        gameState.lastEnergyUpdate = now;
        gameState.activeBoosts = gameState.activeBoosts.filter(b => b.endTime > now);
        renderHeader();
    }, 1000);

    // Auto-save interval
    setInterval(saveGameState, 30000);

    // Event listeners
    document.body.addEventListener('click', handleAction);
    document.getElementById('settingsToggle').addEventListener('click', () => renderModal('Settings', '...'));
    
    navigate('tap');
    updateAll();
    document.getElementById('loadingIndicator').style.display = 'none';
    
    // Initial sync
    syncWithFirebase(true);
};

initGame();
});
</script>
</body>
</html>
